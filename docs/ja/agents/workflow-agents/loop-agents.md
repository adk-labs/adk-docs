# ループ エージェント

## `LoopAgent`

`LoopAgent`は、サブエージェントをループで（つまり反復的に）実行するワークフローエージェントです。指定された反復回数、または終了条件が満たされるまで、**エージェントのシーケンスを繰り返し実行します**。

ワークフローに繰り返しや反復的な改善（コードの修正など）が含まれる場合に`LoopAgent`を使用してください。

### 例

*   食べ物の画像を生成するエージェントを構築したいとします。しかし、特定の数のアイテム（例: 5本のバナナ）を生成したいときに、画像内に異なる数のアイテム（例: 7本のバナナの画像）が生成されることがあります。あなたには`Generate Image`と`Count Food Items`という2つのツールがあります。指定された数のアイテムを正しく生成するか、または特定の反復回数の後に処理を終えたいので、`LoopAgent`を使用してエージェントを構築するべきです。

他の[ワークフローエージェント](index.md)と同様に、`LoopAgent`はLLMによって動作するわけではないため、その実行方法は決定論的です。とはいえ、ワークフローエージェントは自身の実行（つまりループ内での動作）にのみ関与し、その内部ロジックには関与しません。ワークフローエージェントのツールやサブエージェントは、LLMを利用する場合もあれば、利用しない場合もあります。

### 仕組み

`LoopAgent`の`Run Async`メソッドが呼び出されると、以下の処理を実行します。

1.  **サブエージェントの実行:** サブエージェントのリストを_順に_反復処理します。_各_サブエージェントに対して、そのエージェントの`Run Async`メソッドを呼び出します。
2.  **終了条件のチェック:**

    _重要なこととして_、`LoopAgent`自体は、いつループを停止するかを本質的に決定しません。無限ループを防ぐために、終了メカニズムを実装する_必要があります_。一般的な戦略は次のとおりです。

    *   **最大反復回数**: `LoopAgent`に最大反復回数を設定します。**ループはその回数だけ反復した後に終了します**。
    *   **サブエージェントからのエスカレーション**: 1つまたは複数のサブエージェントが条件（例: 「ドキュメントの品質は十分か？」、「合意に達したか？」）を評価するように設計します。条件が満たされた場合、サブエージェントは終了を通知できます（例: カスタムイベントを発生させる、共有コンテキストにフラグを立てる、特定の値を返すなど）。

![Loop Agent](../../assets/loop-agent.png)

### 完全な例: 文書の反復的改善

文書を反復的に改善するシナリオを想像してみてください。

*   **ライターエージェント:** あるトピックに関する下書きを生成または修正する`LlmAgent`。
*   **批評家エージェント:** 下書きを批評し、改善点を特定する`LlmAgent`。

    ```py
    LoopAgent(sub_agents=[WriterAgent, CriticAgent], max_iterations=5)
    ```

この設定では、`LoopAgent`が反復プロセスを管理します。`CriticAgent`は、ドキュメントが満足のいく品質レベルに達したときに「STOP」シグナルを返すように**設計する**ことができ、それ以上の反復を防ぎます。あるいは、`max_iterations`パラメータを使用してプロセスを固定回数のサイクルに制限したり、停止を決定するための外部ロジックを実装したりすることもできます。この**ループは最大5回実行され**、反復的な改善が無限に続かないようにします。

???+ "完全なコード"

    === "Python"
        ```py
        --8<-- "examples/python/snippets/agents/workflow-agents/loop_agent_doc_improv_agent.py:init"
        ```
    === "Java"
        ```java
        --8<-- "examples/java/snippets/src/main/java/agents/workflow/LoopAgentExample.java:init"
        ```