<!--
 Copyright 2025 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->


<!doctype html>
<html lang="ja" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Build powerful multi-agent systems with Agent Development Kit">
      
      
      
        <link rel="canonical" href="https://adk-labs.github.io/adk-docs/ja/tutorials/agent-team/">
      
      
        <link rel="prev" href="../">
      
      
        <link rel="next" href="../../agents/">
      
      
      <link rel="icon" href="../../../assets/agent-development-kit.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>エージェントチーム - Agent Development Kit</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Google+Sans:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Google Sans";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/custom.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  <!-- HTML Meta Tags -->
  <title>Agent Development Kit</title>
  <meta name="description" content="Build powerful multi-agent systems with Agent Development Kit">

  <!-- Facebook Meta Tags -->
  <meta property="og:url" content="https://google.github.io/adk-docs">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Agent Development Kit">
  <meta property="og:description" content="Build powerful multi-agent systems with Agent Development Kit">
  <meta property="og:image" content="https://google.github.io/adk-docs/assets/adk-social-card.png">

  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="twitter:domain" content="google.github.io">
  <meta property="twitter:url" content="https://google.github.io/adk-docs">
  <meta name="twitter:title" content="Agent Development Kit">
  <meta name="twitter:description" content="Build powerful multi-agent systems with Agent Development Kit">
  <meta name="twitter:image" content="https://google.github.io/adk-docs/assets/adk-social-card.png">

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="white">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#adk" class="md-skip">
          コンテンツにスキップ
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      <!--
 Copyright 2025 Google LLC

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<!-- Determine classes -->


  


<!-- Header -->
<header class="md-header md-header--shadow" data-md-component="header">
  <nav
    class="md-header__inner md-grid"
    aria-label="ヘッダー"
  >

    <!-- Link to home -->
    <a
      href="../../"
      title="Agent Development Kit"
      class="md-header__button md-logo"
      aria-label="Agent Development Kit"
      data-md-component="logo"
    >
      
  <img src="../../../assets/agent-development-kit.png" alt="logo">

    </a>

    <!-- Button to open drawer -->
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>

    <!-- Header title -->
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            <a
      href="../../"
      title="Agent Development Kit"
      aria-label="Agent Development Kit"
      data-md-component="logo"
    >
            Agent Development Kit
            </a>
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              エージェントチーム
            
            </a>
          </span>
        </div>
      </div>
    </div>

    <!-- Color palette toggle -->
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="white"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="white" data-md-color-accent="white"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    

    <!-- User preference: color palette -->
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    

    <!-- Site language selector -->
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="言語切り替え">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../../tutorials/agent-team/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../../ko/tutorials/agent-team/" hreflang="ko" class="md-select__link">
              한국어
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="ja" class="md-select__link">
              日本語
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    

    <!-- Button to open search modal -->
    
      

      <!-- Check if search is actually enabled - see https://t.ly/DT_0V -->
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>

        <!-- Search interface -->
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="検索" placeholder="検索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="検索">
        
        <button type="reset" class="md-search__icon md-icon" title="クリア" aria-label="クリア" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            検索を初期化
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    

    <!-- Repository information -->
    
      <div class="md-header__source">
        <!-- First Repository information -->
<a
  href="https://github.com/google/adk-python"
  title="リポジトリへ"
  class="md-source"
  data-md-component="source"
  style="margin-right: 10px;"
>
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    adk-python
  </div>
</a>

<!-- Second Repository information -->
<a
  href="https://github.com/google/adk-java"
  title="adk-java"
  class="md-source"
  data-md-component="source"
>
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    adk-java
  </div>
</a> 
      </div>
    
  </nav>

  <!-- Navigation tabs (sticky) -->
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="ナビゲーション" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../" title="Agent Development Kit" class="md-nav__button md-logo" aria-label="Agent Development Kit" data-md-component="logo">
      
  <img src="../../../assets/agent-development-kit.png" alt="logo">

    </a>
    Agent Development Kit
  </label>
  
    <div class="md-nav__source">
      <!-- First Repository information -->
<a
  href="https://github.com/google/adk-python"
  title="リポジトリへ"
  class="md-source"
  data-md-component="source"
  style="margin-right: 10px;"
>
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    adk-python
  </div>
</a>

<!-- Second Repository information -->
<a
  href="https://github.com/google/adk-java"
  title="adk-java"
  class="md-source"
  data-md-component="source"
>
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    adk-java
  </div>
</a> 
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ホーム
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../get-started/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    はじめに
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            はじめに
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    インストール
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    クイックスタート
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../get-started/streaming/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    クイックスタート(ストリーミング)
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            クイックスタート(ストリーミング)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/streaming/quickstart-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/streaming/quickstart-streaming-java/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    テスト
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/google/adk-samples" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    サンプルエージェント
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ADKについて
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    チュートリアル
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            チュートリアル
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    エージェントチーム
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    エージェントチーム
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目次">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目次
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-" class="md-nav__link">
    <span class="md-ellipsis">
      ステップ1：最初のエージェント - 基本的な天気の検索
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2litellm" class="md-nav__link">
    <span class="md-ellipsis">
      ステップ2：LiteLLMでマルチモデル化 [オプション]
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-" class="md-nav__link">
    <span class="md-ellipsis">
      ステップ3：エージェントチームの構築 - 挨拶と別れの委任
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      ステップ4：セッション状態でメモリとパーソナライズを追加する
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-before_model_callback" class="md-nav__link">
    <span class="md-ellipsis">
      ステップ5：安全性の追加 - before_model_callbackによる入力ガードレール
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-before_tool_callback" class="md-nav__link">
    <span class="md-ellipsis">
      ステップ6：安全性の追加 - ツール引数ガードレール (before_tool_callback)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      結論：あなたのエージェントチームは準備完了です！
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../agents/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    エージェント
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            エージェント
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/llm-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    LLMエージェント
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../agents/workflow-agents/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    ワークフローエージェント
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            ワークフローエージェント
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/workflow-agents/sequential-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    シーケンシャルエージェント
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/workflow-agents/loop-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ループエージェント
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/workflow-agents/parallel-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    パラレルエージェント
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/custom-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    カスタムエージェント
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/multi-agents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    マルチエージェントシステム
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../agents/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    モデル定義
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../tools/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    ツール
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            ツール
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/function-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    関数ツール
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/built-in-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    内蔵ツール
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/third-party-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    サードパーティツール
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/google-cloud-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Google Cloudツール
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/mcp-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MCPツール
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/openapi-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OpenAPIツール
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tools/authentication/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    認証
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../runtime/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    エージェントの実行
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            エージェントの実行
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../runtime/runconfig/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ランタイム設定
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../deploy/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    デプロイ
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            デプロイ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/agent-engine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    エージェントエンジン
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/cloud-run/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Cloud Run
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deploy/gke/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    GKE
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../sessions/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    セッションとメモリ
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            セッションとメモリ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sessions/session/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    セッション
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sessions/state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ステート
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sessions/memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    メモリ
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../callbacks/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    コールバック
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9" id="__nav_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            コールバック
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../callbacks/types-of-callbacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    コールバックの種類
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../callbacks/design-patterns-and-best-practices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    デザインパターンとベストプラクティス
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../artifacts/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    アーティファクト
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            アーティファクト
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../events/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    イベント
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            イベント
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../context/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    コンテキスト
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            コンテキスト
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    オブザーバビリティ
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            オブザーバビリティ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/arize-ax/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Arize AX
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/phoenix/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Phoenix
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../evaluate/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    評価
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            評価
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../mcp/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    MCP
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_15">
            <span class="md-nav__icon md-icon"></span>
            MCP
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../streaming/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    双方向ストリーミング(ライブ)
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_16" id="__nav_16_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_16">
            <span class="md-nav__icon md-icon"></span>
            双方向ストリーミング(ライブ)
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../get-started/streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ストリーミング
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../streaming/custom-streaming/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    カスタム音声双方向ストリーミングアプリのサンプル (SSE)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../streaming/custom-streaming-ws/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    カスタム音声双方向ストリーミングアプリのサンプル (WebSockets)
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../streaming/dev-guide/part1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    双方向ストリーミング開発ガイドシリーズ
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../streaming/streaming-tools/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ストリーミングツール
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../streaming/configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    双方向ストリーミングの動作設定
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../safety/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    安全性とセキュリティ
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/google/A2A/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent2Agent (A2A) プロトコル
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../community/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    コミュニティリソース
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contributing-guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    コントリビューションガイド
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_21" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../api-reference/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    APIリファレンス
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_21" id="__nav_21_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_21_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_21">
            <span class="md-nav__icon md-icon"></span>
            APIリファレンス
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://google.github.io/adk-docs/api-reference/python/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Python ADK
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://google.github.io/adk-docs/api-reference/java/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java ADK
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目次">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目次
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-" class="md-nav__link">
    <span class="md-ellipsis">
      ステップ1：最初のエージェント - 基本的な天気の検索
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2litellm" class="md-nav__link">
    <span class="md-ellipsis">
      ステップ2：LiteLLMでマルチモデル化 [オプション]
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-" class="md-nav__link">
    <span class="md-ellipsis">
      ステップ3：エージェントチームの構築 - 挨拶と別れの委任
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      ステップ4：セッション状態でメモリとパーソナライズを追加する
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-before_model_callback" class="md-nav__link">
    <span class="md-ellipsis">
      ステップ5：安全性の追加 - before_model_callbackによる入力ガードレール
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-before_tool_callback" class="md-nav__link">
    <span class="md-ellipsis">
      ステップ6：安全性の追加 - ツール引数ガードレール (before_tool_callback)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      結論：あなたのエージェントチームは準備完了です！
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="adk">初めてのインテリジェントエージェントチームを構築する：ADKを使った先進的な天気ボット<a class="headerlink" href="#adk" title="Permanent link">&para;</a></h1>
<!-- オプション：全体的なパディング/スペーシングのための外側コンテナ -->
<div style="padding: 10px 0;">

  <!-- 1行目: Colabで開く -->
  <!-- このdivはリンクを独自の行にし、下にスペースを追加します -->
  <div style="margin-bottom: 10px;">
    <a href="https://colab.research.google.com/github/google/adk-docs/blob/main/examples/python/tutorial/agent_team/adk_tutorial.ipynb" target="_blank" style="display: inline-flex; align-items: center; gap: 5px; text-decoration: none; color: #4285F4;">
      <img width="32px" src="https://www.gstatic.com/pantheon/images/bigquery/welcome_page/colab-logo.svg" alt="Google Colaboratory ロゴ">
      <span>Colabで開く</span>
    </a>
  </div>

  <!-- 2行目: 共有リンク -->
  <!-- このdivは「共有先：」テキストとアイコンのフレックスコンテナとして機能します -->
  <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
    <!-- 共有テキスト -->
    <span style="font-weight: bold;">共有先：</span>

    <!-- ソーシャルメディアリンク -->
    <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A//github/google/adk-docs/blob/main/examples/python/tutorial/agent_team/adk_tutorial.ipynb" target="_blank" title="LinkedInで共有">
      <img width="20px" src="https://upload.wikimedia.org/wikipedia/commons/8/81/LinkedIn_icon.svg" alt="LinkedIn ロゴ" style="vertical-align: middle;">
    </a>
    <a href="https://bsky.app/intent/compose?text=https%3A//github/google/adk-docs/blob/main/examples/python/tutorial/agent_team/adk_tutorial.ipynb" target="_blank" title="Blueskyで共有">
      <img width="20px" src="https://upload.wikimedia.org/wikipedia/commons/7/7a/Bluesky_Logo.svg" alt="Bluesky ロゴ" style="vertical-align: middle;">
    </a>
    <a href="https://twitter.com/intent/tweet?url=https%3A//github/google/adk-docs/blob/main/examples/python/tutorial/agent_team/adk_tutorial.ipynb" target="_blank" title="X (Twitter)で共有">
      <img width="20px" src="https://upload.wikimedia.org/wikipedia/commons/5/5a/X_icon_2.svg" alt="X ロゴ" style="vertical-align: middle;">
    </a>
    <a href="https://reddit.com/submit?url=https%3A//github/google/adk-docs/blob/main/examples/python/tutorial/agent_team/adk_tutorial.ipynb" target="_blank" title="Redditで共有">
      <img width="20px" src="https://redditinc.com/hubfs/Reddit%20Inc/Brand/Reddit_Logo.png" alt="Reddit ロゴ" style="vertical-align: middle;">
    </a>
    <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//github/google/adk-docs/blob/main/examples/python/tutorial/agent_team/adk_tutorial.ipynb" target="_blank" title="Facebookで共有">
      <img width="20px" src="https://upload.wikimedia.org/wikipedia/commons/5/51/Facebook_f_logo_%282019%29.svg" alt="Facebook ロゴ" style="vertical-align: middle;">
    </a>
  </div>

</div>

<p>このチュートリアルは、<a href="https://google.github.io/adk-docs/get-started/">Agent Development Kit</a>の<a href="https://google.github.io/adk-docs/get-started/quickstart/">クイックスタート例</a>を拡張したものです。さあ、より深く掘り下げて、より洗練された<strong>マルチエージェントシステム</strong>を構築する準備をしましょう。</p>
<p>私たちは、単純な基盤の上に高度な機能を段階的に重ねながら、<strong>天気ボットのエージェントチーム</strong>の構築に着手します。天気を調べることができる単一のエージェントから始め、次のような機能を段階的に追加していきます：</p>
<ul>
<li>異なるAIモデル（Gemini, GPT, Claude）の活用</li>
<li>挨拶や別れのような特定のタスクのための専門的なサブエージェントの設計</li>
<li>エージェント間のインテリジェントな委任の有効化</li>
<li>永続的なセッション状態を使用したエージェントへのメモリの付与</li>
<li>コールバックを使用した重要な安全ガードレールの実装</li>
</ul>
<p><strong>なぜ天気ボットチームなのか？</strong></p>
<p>このユースケースは、一見シンプルですが、複雑で実世界のエージェントアプリケーションを構築するために不可欠なADKのコアコンセプトを探求するための、実践的で親しみやすいキャンバスを提供します。インタラクションの構造化、状態の管理、安全性の確保、そして協力して働く複数のAI「頭脳」のオーケストレーション方法を学びます。</p>
<p><strong>ADKとは？</strong></p>
<p>念のためですが、ADKは大規模言語モデル（LLM）を搭載したアプリケーションの開発を効率化するために設計されたPythonフレームワークです。推論、計画、ツールの利用、ユーザーとの動的な対話、そしてチーム内での効果的な協力を可能にするエージェントを作成するための堅牢なビルディングブロックを提供します。</p>
<p><strong>この高度なチュートリアルで、あなたは以下をマスターします：</strong></p>
<ul>
<li>✅ <strong>ツールの定義と使用法：</strong> エージェントに特定の能力（データ取得など）を与えるPython関数（<code>ツール</code>）を作成し、エージェントにそれらを効果的に使用する方法を指示します。</li>
<li>✅ <strong>マルチLLMの柔軟性：</strong> LiteLLM統合を介して、エージェントが様々な主要LLM（Gemini, GPT-4o, Claude Sonnet）を利用するように設定し、各タスクに最適なモデルを選択できるようにします。</li>
<li>✅ <strong>エージェントの委任と協力：</strong> 専門的なサブエージェントを設計し、ユーザーのリクエストをチーム内で最も適切なエージェントに自動的にルーティング（<code>auto flow</code>）できるようにします。</li>
<li>✅ <strong>メモリのためのセッション状態：</strong> <code>Session State</code>と<code>ToolContext</code>を利用して、エージェントが会話のターンを越えて情報を記憶できるようにし、より文脈に沿ったインタラクションを実現します。</li>
<li>✅ <strong>コールバックによる安全ガードレール：</strong> <code>before_model_callback</code>と<code>before_tool_callback</code>を実装して、事前定義されたルールに基づいてリクエストやツールの使用を検査、変更、またはブロックし、アプリケーションの安全性と制御を強化します。</li>
</ul>
<p><strong>最終的な目標：</strong></p>
<p>このチュートリアルを完了することで、あなたは機能的なマルチエージェントの天気ボットシステムを構築します。このシステムは、天気情報を提供するだけでなく、会話の丁寧なやり取りを処理し、最後にチェックした都市を記憶し、定義された安全境界内で動作し、すべてADKを使用してオーケストレーションされます。</p>
<p><strong>前提条件：</strong></p>
<ul>
<li>✅ <strong>Pythonプログラミングの確かな理解。</strong></li>
<li>✅ <strong>大規模言語モデル（LLM）、API、およびエージェントの概念に精通していること。</strong></li>
<li>❗ <strong>重要：ADKクイックスタートチュートリアルの完了、またはADKの基本（Agent, Runner, SessionService, 基本的なツールの使用法）に関する同等の基礎知識。</strong> このチュートリアルは、これらの概念の上に直接構築されます。</li>
<li>✅ 使用するLLMの<strong>APIキー</strong>（例：Gemini用のGoogle AI Studio、OpenAI Platform、Anthropic Console）。</li>
</ul>
<hr />
<p><strong>実行環境に関する注意：</strong></p>
<p>このチュートリアルは、Google Colab、Colab Enterprise、またはJupyterノートブックのようなインタラクティブなノートブック環境向けに構成されています。以下の点に留意してください：</p>
<ul>
<li><strong>非同期コードの実行：</strong> ノートブック環境は非同期コードを異なる方法で扱います。<code>await</code>（イベントループが既に実行中の場合、ノートブックで一般的）や<code>asyncio.run()</code>（スタンドアロンの<code>.py</code>スクリプトとして実行する場合や特定のノートブック設定で必要）を使用した例が表示されます。コードブロックは両方のシナリオのガイダンスを提供します。</li>
<li><strong>手動でのRunner/Sessionセットアップ：</strong> 手順には、<code>Runner</code>と<code>SessionService</code>インスタンスを明示的に作成することが含まれます。このアプローチは、エージェントの実行ライフサイクル、セッション管理、および状態の永続化をきめ細かく制御できるため、示されています。</li>
</ul>
<p><strong>代替案：ADKの組み込みツール（Web UI / CLI / APIサーバー）の使用</strong></p>
<p>ADKの標準ツールを使用してランナーとセッション管理を自動的に処理するセットアップを好む場合は、その目的で構成された同等のコードを<a href="https://github.com/google/adk-docs/tree/main/examples/python/tutorial/agent_team/adk-tutorial">こちら</a>で見つけることができます。そのバージョンは、<code>adk web</code>（Web UI用）、<code>adk run</code>（CLIインタラクション用）、または<code>adk api_server</code>（APIを公開するため）のようなコマンドで直接実行するように設計されています。その代替リソースで提供されている<code>README.md</code>の指示に従ってください。</p>
<hr />
<p><strong>エージェントチームを構築する準備はできましたか？さあ、始めましょう！</strong></p>
<blockquote>
<p><strong>注意：</strong> このチュートリアルはadkバージョン1.0.0以上で動作します。</p>
</blockquote>
<div class="language-python highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># @title ステップ0：セットアップとインストール</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="c1"># ADKとLiteLLMをインストールしてマルチモデルをサポート</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">google</span><span class="o">-</span><span class="n">adk</span> <span class="o">-</span><span class="n">q</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">litellm</span> <span class="o">-</span><span class="n">q</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;インストールが完了しました。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="c1"># @title 必要なライブラリのインポート</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.lite_llm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiteLlm</span> <span class="c1"># マルチモデルサポート用</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.sessions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemorySessionService</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.runners</span><span class="w"> </span><span class="kn">import</span> <span class="n">Runner</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.genai</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span> <span class="c1"># メッセージのContent/Parts作成用</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="c1"># すべての警告を無視</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ライブラリがインポートされました。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="c1"># @title APIキーの設定（実際のキーに置き換えてください！）</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="c1"># --- 重要：プレースホルダーを実際のAPIキーに置き換えてください ---</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="c1"># Gemini APIキー（Google AI Studioから取得：https://aistudio.google.com/app/apikey）</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;GOOGLE_API_KEY&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;YOUR_GOOGLE_API_KEY&quot;</span> <span class="c1"># &lt;--- 置き換えてください</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="c1"># [オプション]</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="c1"># OpenAI APIキー（OpenAI Platformから取得：https://platform.openai.com/api-keys）</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OPENAI_API_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;YOUR_OPENAI_API_KEY&#39;</span> <span class="c1"># &lt;--- 置き換えてください</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="c1"># [オプション]</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="c1"># Anthropic APIキー（Anthropic Consoleから取得：https://console.anthropic.com/settings/keys）</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ANTHROPIC_API_KEY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;YOUR_ANTHROPIC_API_KEY&#39;</span> <span class="c1"># &lt;--- 置き換えてください</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="c1"># --- キーの確認（オプションのチェック） ---</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;APIキー設定：&quot;</span><span class="p">)</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Google APIキー設定済み：</span><span class="si">{</span><span class="s1">&#39;はい&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GOOGLE_API_KEY&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GOOGLE_API_KEY&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;YOUR_GOOGLE_API_KEY&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;いいえ（プレースホルダーを置き換えてください！）&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenAI APIキー設定済み：</span><span class="si">{</span><span class="s1">&#39;はい&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OPENAI_API_KEY&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OPENAI_API_KEY&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;YOUR_OPENAI_API_KEY&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;いいえ（プレースホルダーを置き換えてください！）&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Anthropic APIキー設定済み：</span><span class="si">{</span><span class="s1">&#39;はい&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ANTHROPIC_API_KEY&#39;</span><span class="p">)</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;ANTHROPIC_API_KEY&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">&#39;YOUR_ANTHROPIC_API_KEY&#39;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;いいえ（プレースホルダーを置き換えてください！）&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="c1"># ADKが直接APIキーを使用するように設定（このマルチモデル設定ではVertex AIは使用しない）</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;GOOGLE_GENAI_USE_VERTEXAI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;False&quot;</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="c1"># @markdown **セキュリティノート：** APIキーは、ノートブックに直接ハードコーディングするのではなく、安全に管理する（例：Colabのシークレット機能や環境変数を使用する）ことがベストプラクティスです。上記のプレースホルダー文字列を置き換えてください。</span>
</span></code></pre></div>
<div class="language-python highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># --- 使いやすいようにモデル定数を定義 ---</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="c1"># サポートされているモデルの詳細はここで参照できます：https://ai.google.dev/gemini-api/docs/models#model-variations</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="n">MODEL_GEMINI_2_0_FLASH</span> <span class="o">=</span> <span class="s2">&quot;gemini-2.0-flash&quot;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="c1"># サポートされているモデルの詳細はここで参照できます：https://docs.litellm.ai/docs/providers/openai#openai-chat-completion-models</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="n">MODEL_GPT_4O</span> <span class="o">=</span> <span class="s2">&quot;openai/gpt-4.1&quot;</span> <span class="c1"># gpt-4.1-mini, gpt-4oなども試せます</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="c1"># サポートされているモデルの詳細はここで参照できます：https://docs.litellm.ai/docs/providers/anthropic</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="n">MODEL_CLAUDE_SONNET</span> <span class="o">=</span> <span class="s2">&quot;anthropic/claude-sonnet-4-20250514&quot;</span> <span class="c1"># claude-opus-4-20250514 , claude-3-7-sonnet-20250219なども試せます</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">環境が設定されました。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<h2 id="1-">ステップ1：最初のエージェント - 基本的な天気の検索<a class="headerlink" href="#1-" title="Permanent link">&para;</a></h2>
<p>天気ボットの基本的なコンポーネント、つまり特定のタスク（天気情報の検索）を実行できる単一のエージェントを構築することから始めましょう。これには、2つの主要な部分を作成することが含まれます：</p>
<ol>
<li><strong>ツール：</strong> エージェントに天気のデータを取得する<em>能力</em>を与えるPython関数。</li>
<li><strong>エージェント：</strong> ユーザーのリクエストを理解し、天気ツールを持っていることを知り、いつどのようにそれを使用するかを決定するAIの「頭脳」。</li>
</ol>
<hr />
<p><strong>1. ツールの定義 (<code>get_weather</code>)</strong></p>
<p>ADKにおいて、<strong>ツール</strong>はエージェントに単なるテキスト生成を超えた具体的な能力を与える構成要素です。これらは通常、APIの呼び出し、データベースのクエリ、計算の実行など、特定のアクションを実行する通常のPython関数です。</p>
<p>最初のツールは、<em>模擬的な</em>天気予報を提供します。これにより、まだ外部のAPIキーを必要とせずにエージェントの構造に集中できます。後で、この模擬関数を実際の天気サービスを呼び出すものに簡単に交換できます。</p>
<p><strong>重要なコンセプト：docstringは非常に重要です！</strong> エージェントのLLMは、関数の<strong>docstring</strong>に大きく依存して以下を理解します：</p>
<ul>
<li>ツールが<em>何をするか</em>。</li>
<li><em>いつ</em>それを使用するか。</li>
<li><em>どの引数</em>が必要か（<code>city: str</code>）。</li>
<li><em>どのような情報</em>を返すか。</li>
</ul>
<p><strong>ベストプラクティス：</strong> ツールには、明確で、説明的で、正確なdocstringを記述してください。これはLLMがツールを正しく使用するために不可欠です。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="c1"># @title get_weatherツールを定義</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_weather</span><span class="p">(</span><span class="n">city</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;指定された都市の現在の天気予報を取得します。</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="sd">    Args:</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="sd">        city (str): 都市の名前（例：&quot;New York&quot;, &quot;London&quot;, &quot;Tokyo&quot;）。</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="sd">    Returns:</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="sd">        dict: 天気情報を含む辞書。</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="sd">              &#39;status&#39;キー（&#39;success&#39;または&#39;error&#39;）を含む。</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="sd">              &#39;success&#39;の場合、天気詳細を持つ&#39;report&#39;キーを含む。</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="sd">              &#39;error&#39;の場合、&#39;error_message&#39;キーを含む。</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- ツール：get_weatherが都市：</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">で呼び出されました ---&quot;</span><span class="p">)</span> <span class="c1"># ツールの実行をログに記録</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="n">city_normalized</span> <span class="o">=</span> <span class="n">city</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># 基本的な正規化</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>    <span class="c1"># 模擬的な天気データ</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>    <span class="n">mock_weather_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>        <span class="s2">&quot;newyork&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="s2">&quot;ニューヨークの天気は晴れで、気温は25℃です。&quot;</span><span class="p">},</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>        <span class="s2">&quot;london&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="s2">&quot;ロンドンは曇りで、気温は15℃です。&quot;</span><span class="p">},</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>        <span class="s2">&quot;tokyo&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="s2">&quot;東京は小雨で、気温は18℃です。&quot;</span><span class="p">},</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>    <span class="p">}</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>    <span class="k">if</span> <span class="n">city_normalized</span> <span class="ow">in</span> <span class="n">mock_weather_db</span><span class="p">:</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>        <span class="k">return</span> <span class="n">mock_weather_db</span><span class="p">[</span><span class="n">city_normalized</span><span class="p">]</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;申し訳ありませんが、&#39;</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">&#39;の天気情報はありません。&quot;</span><span class="p">}</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="c1"># ツールの使用例（オプションのテスト）</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="nb">print</span><span class="p">(</span><span class="n">get_weather</span><span class="p">(</span><span class="s2">&quot;New York&quot;</span><span class="p">))</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a><span class="nb">print</span><span class="p">(</span><span class="n">get_weather</span><span class="p">(</span><span class="s2">&quot;Paris&quot;</span><span class="p">))</span>
</span></code></pre></div>
<hr />
<p><strong>2. エージェントの定義 (<code>weather_agent</code>)</strong></p>
<p>次に、<strong>エージェント</strong>自体を作成しましょう。ADKの<code>Agent</code>は、ユーザー、LLM、および利用可能なツール間のインタラクションを調整します。</p>
<p>いくつかの重要なパラメータで設定します：</p>
<ul>
<li><code>name</code>: このエージェントの一意の識別子（例："weather_agent_v1"）。</li>
<li><code>model</code>: 使用するLLMを指定します（例：<code>MODEL_GEMINI_2_0_FLASH</code>）。まず特定のGeminiモデルから始めます。</li>
<li><code>description</code>: エージェントの全体的な目的の簡潔な要約。これは後で他のエージェントが<em>この</em>エージェントにタスクを委任するかどうかを決定する必要がある場合に重要になります。</li>
<li><code>instruction</code>: LLMに対する振る舞い、ペルソナ、目標、そして特に割り当てられた<code>tools</code>を<em>どのように、いつ</em>利用するかに関する詳細なガイダンス。</li>
<li><code>tools</code>: エージェントが使用を許可されている実際のPythonツール関数のリスト（例：<code>[get_weather]</code>）。</li>
</ul>
<p><strong>ベストプラクティス：</strong> 明確で具体的な<code>instruction</code>プロンプトを提供してください。指示が詳細であればあるほど、LLMはその役割とツールの使用方法をよりよく理解できます。必要であればエラーハンドリングについて明示的に記述してください。</p>
<p><strong>ベストプラクティス：</strong> 説明的な<code>name</code>と<code>description</code>の値を選択してください。これらはADKによって内部的に使用され、自動委任（後述）のような機能にとって不可欠です。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># @title 天気エージェントを定義</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="c1"># 先に定義したモデル定数のいずれかを使用</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="n">AGENT_MODEL</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span> <span class="c1"># Geminiから始める</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="n">weather_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v1&quot;</span><span class="p">,</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>    <span class="n">model</span><span class="o">=</span><span class="n">AGENT_MODEL</span><span class="p">,</span> <span class="c1"># Geminiの場合は文字列、またはLiteLlmオブジェクト</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;特定の都市の天気情報を提供します。&quot;</span><span class="p">,</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;あなたは親切な天気アシスタントです。&quot;</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>                <span class="s2">&quot;ユーザーが特定の都市の天気を尋ねたときは、&quot;</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>                <span class="s2">&quot;&#39;get_weather&#39;ツールを使って情報を見つけてください。&quot;</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>                <span class="s2">&quot;ツールがエラーを返した場合は、ユーザーに丁寧に伝えてください。&quot;</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>                <span class="s2">&quot;ツールが成功した場合は、天気予報を明確に提示してください。&quot;</span><span class="p">,</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather</span><span class="p">],</span> <span class="c1"># 関数を直接渡す</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="p">)</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;エージェント&#39;</span><span class="si">{</span><span class="n">weather_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;がモデル&#39;</span><span class="si">{</span><span class="n">AGENT_MODEL</span><span class="si">}</span><span class="s2">&#39;を使用して作成されました。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>3. RunnerとSession Serviceのセットアップ</strong></p>
<p>会話を管理し、エージェントを実行するために、さらに2つのコンポーネントが必要です：</p>
<ul>
<li><code>SessionService</code>: 異なるユーザーやセッションの会話履歴と状態を管理する責任があります。<code>InMemorySessionService</code>は、すべてをメモリに保存する簡単な実装で、テストや単純なアプリケーションに適しています。交換されたメッセージを追跡します。ステップ4で状態の永続化について詳しく探ります。</li>
<li><code>Runner</code>: インタラクションフローを調整するエンジンです。ユーザー入力を受け取り、適切なエージェントにルーティングし、エージェントのロジックに基づいてLLMとツールへの呼び出しを管理し、<code>SessionService</code>を介してセッションの更新を処理し、インタラクションの進行状況を表すイベントを生成します。</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="c1"># @title Session ServiceとRunnerのセットアップ</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="c1"># --- セッション管理 ---</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="c1"># 重要なコンセプト：SessionServiceは会話履歴と状態を保存します。</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="c1"># InMemorySessionServiceはこのチュートリアルのための単純で非永続的なストレージです。</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="n">session_service</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="c1"># インタラクションコンテキストを識別するための定数を定義</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="n">APP_NAME</span> <span class="o">=</span> <span class="s2">&quot;weather_tutorial_app&quot;</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="n">USER_ID</span> <span class="o">=</span> <span class="s2">&quot;user_1&quot;</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="n">SESSION_ID</span> <span class="o">=</span> <span class="s2">&quot;session_001&quot;</span> <span class="c1"># 簡単のため固定IDを使用</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="c1"># 会話が行われる特定のセッションを作成</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>    <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>    <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="p">)</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;セッションが作成されました：App=&#39;</span><span class="si">{</span><span class="n">APP_NAME</span><span class="si">}</span><span class="s2">&#39;, User=&#39;</span><span class="si">{</span><span class="n">USER_ID</span><span class="si">}</span><span class="s2">&#39;, Session=&#39;</span><span class="si">{</span><span class="n">SESSION_ID</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="c1"># --- Runner ---</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="c1"># 重要なコンセプト：Runnerはエージェントの実行ループを調整します。</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="n">runner</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>    <span class="n">agent</span><span class="o">=</span><span class="n">weather_agent</span><span class="p">,</span> <span class="c1"># 実行したいエージェント</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>    <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>   <span class="c1"># 実行をアプリに関連付ける</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>    <span class="n">session_service</span><span class="o">=</span><span class="n">session_service</span> <span class="c1"># セッションマネージャーを使用</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="p">)</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runnerがエージェント&#39;</span><span class="si">{</span><span class="n">runner</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;のために作成されました。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>4. エージェントとの対話</strong></p>
<p>エージェントにメッセージを送信し、その応答を受け取る方法が必要です。LLMの呼び出しやツールの実行には時間がかかることがあるため、ADKの<code>Runner</code>は非同期で動作します。</p>
<p><code>async</code>ヘルパー関数（<code>call_agent_async</code>）を定義します。この関数は：</p>
<ol>
<li>ユーザーのクエリ文字列を受け取ります。</li>
<li>それをADKの<code>Content</code>形式にパッケージ化します。</li>
<li><code>runner.run_async</code>を呼び出し、ユーザー/セッションのコンテキストと新しいメッセージを提供します。</li>
<li>ランナーによって生成される<strong>イベント</strong>を反復処理します。イベントはエージェントの実行におけるステップ（例：ツール呼び出し要求、ツール結果受信、中間的なLLMの思考、最終応答）を表します。</li>
<li><code>event.is_final_response()</code>を使用して<strong>最終応答</strong>イベントを識別し、出力します。</li>
</ol>
<p><strong>なぜ<code>async</code>なのか？</strong> LLMや潜在的なツール（外部APIなど）とのインタラクションはI/Oバウンドな操作です。<code>asyncio</code>を使用すると、プログラムは実行をブロックすることなくこれらの操作を効率的に処理できます。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="c1"># @title エージェント対話関数を定義</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.genai</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span> <span class="c1"># メッセージのContent/Parts作成用</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">runner</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">):</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">  </span><span class="sd">&quot;&quot;&quot;エージェントにクエリを送信し、最終応答を出力します。&quot;&quot;&quot;</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt;&gt;&gt; ユーザーのクエリ：</span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a>  <span class="c1"># ユーザーのメッセージをADK形式で準備</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a>  <span class="n">content</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">query</span><span class="p">)])</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>  <span class="n">final_response_text</span> <span class="o">=</span> <span class="s2">&quot;エージェントは最終応答を生成しませんでした。&quot;</span> <span class="c1"># デフォルト</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a>  <span class="c1"># 重要なコンセプト：run_asyncはエージェントのロジックを実行し、イベントを生成します。</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a>  <span class="c1"># イベントを反復処理して最終的な答えを見つけます。</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a>  <span class="k">async</span> <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">runner</span><span class="o">.</span><span class="n">run_async</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">session_id</span><span class="p">,</span> <span class="n">new_message</span><span class="o">=</span><span class="n">content</span><span class="p">):</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>      <span class="c1"># 以下の行のコメントを外すと、実行中の*すべて*のイベントを見ることができます</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>      <span class="c1"># print(f&quot;  [イベント] Author: {event.author}, Type: {type(event).__name__}, Final: {event.is_final_response()}, Content: {event.content}&quot;)</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a>      <span class="c1"># 重要なコンセプト：is_final_response()はターンの結論となるメッセージをマークします。</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>      <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">is_final_response</span><span class="p">():</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a>          <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>             <span class="c1"># 最初のパートにテキスト応答があると仮定</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a>             <span class="n">final_response_text</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">text</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a>          <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">actions</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">escalate</span><span class="p">:</span> <span class="c1"># 潜在的なエラー/エスカレーションを処理</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>             <span class="n">final_response_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;エージェントがエスカレーションしました：</span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">error_message</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;特定のエラーメッセージはありません。&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>          <span class="c1"># 必要に応じてここに追加のチェックを追加（例：特定のエラーコード）</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a>          <span class="k">break</span> <span class="c1"># 最終応答が見つかったらイベントの処理を停止</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>  <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;&lt;&lt; エージェントの応答：</span><span class="si">{</span><span class="n">final_response_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>5. 会話の実行</strong></p>
<p>最後に、エージェントにいくつかのクエリを送信してセットアップをテストしましょう。<code>async</code>呼び出しをメインの<code>async</code>関数でラップし、<code>await</code>を使用して実行します。</p>
<p>出力を観察してください：</p>
<ul>
<li>ユーザーのクエリが表示されます。</li>
<li>エージェントがツールを使用すると<code>--- ツール：get_weatherが呼び出されました... ---</code>のログが表示されます。</li>
<li>天気データが利用できない場合（パリの場合）の処理方法を含む、エージェントの最終応答を観察してください。</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># @title 初回の会話を実行</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="c1"># 対話ヘルパーを待機するためにasync関数が必要</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_conversation</span><span class="p">():</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="s2">&quot;ロンドンの天気はどうですか？&quot;</span><span class="p">,</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>                                       <span class="n">runner</span><span class="o">=</span><span class="n">runner</span><span class="p">,</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>                                       <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>                                       <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="s2">&quot;パリはどうですか？&quot;</span><span class="p">,</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a>                                       <span class="n">runner</span><span class="o">=</span><span class="n">runner</span><span class="p">,</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a>                                       <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>                                       <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span> <span class="c1"># ツールのエラーメッセージを期待</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="s2">&quot;ニューヨークの天気を教えて&quot;</span><span class="p">,</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a>                                       <span class="n">runner</span><span class="o">=</span><span class="n">runner</span><span class="p">,</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a>                                       <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a>                                       <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="c1"># asyncコンテキスト（Colab/Jupyterなど）でawaitを使用して会話を実行</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="k">await</span> <span class="n">run_conversation</span><span class="p">()</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="c1"># --- または ---</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="c1"># 標準のPythonスクリプト（.pyファイル）として実行する場合は、以下の行のコメントを外してください：</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="c1"># import asyncio</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="c1"># if __name__ == &quot;__main__&quot;:</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="c1">#     try:</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="c1">#         asyncio.run(run_conversation())</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="c1">#     except Exception as e:</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="c1">#         print(f&quot;エラーが発生しました：{e}&quot;)</span>
</span></code></pre></div>
<hr />
<p>おめでとうございます！これで最初のADKエージェントを正常に構築し、対話することができました。それはユーザーのリクエストを理解し、ツールを使って情報を見つけ、ツールの結果に基づいて適切に応答します。</p>
<p>次のステップでは、このエージェントを動かす基盤となる言語モデルを簡単に切り替える方法を探ります。</p>
<h2 id="2litellm">ステップ2：LiteLLMでマルチモデル化 [オプション]<a class="headerlink" href="#2litellm" title="Permanent link">&para;</a></h2>
<p>ステップ1では、特定のGeminiモデルを搭載した機能的な天気エージェントを構築しました。効果的ではありますが、実世界のアプリケーションでは、しばしば<em>異なる</em>大規模言語モデル（LLM）を使用する柔軟性が役立ちます。なぜでしょうか？</p>
<ul>
<li><strong>パフォーマンス：</strong> 特定のタスク（例：コーディング、推論、創造的な執筆）に優れたモデルがあります。</li>
<li><strong>コスト：</strong> モデルによって価格帯が異なります。</li>
<li><strong>能力：</strong> モデルは多様な機能、コンテキストウィンドウサイズ、ファインチューニングオプションを提供します。</li>
<li><strong>可用性/冗長性：</strong> 代替手段を持つことで、あるプロバイダーで問題が発生してもアプリケーションが機能し続けることが保証されます。</li>
</ul>
<p>ADKは、<a href="https://github.com/BerriAI/litellm"><strong>LiteLLM</strong></a>ライブラリとの統合を通じて、モデル間の切り替えをシームレスにします。LiteLLMは、100以上の異なるLLMへの一貫したインターフェースとして機能します。</p>
<p><strong>このステップでは、以下のことを行います：</strong></p>
<ol>
<li>ADKの<code>Agent</code>を、<code>LiteLlm</code>ラッパーを使用してOpenAI（GPT）やAnthropic（Claude）などのプロバイダーのモデルを使用するように設定する方法を学びます。</li>
<li>それぞれが異なるLLMに支えられた天気エージェントのインスタンスを定義、設定（独自のセッションとランナーで）し、すぐにテストします。</li>
<li>これらの異なるエージェントと対話し、同じ基盤となるツールを使用していても、応答に潜在的なバリエーションがあることを観察します。</li>
</ol>
<hr />
<p><strong>1. <code>LiteLlm</code>のインポート</strong></p>
<p>これは初期セットアップ（ステップ0）中にインポートしましたが、マルチモデルサポートの重要なコンポーネントです：</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1"># @title 1. LiteLlmをインポート</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.lite_llm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiteLlm</span>
</span></code></pre></div>
<p><strong>2. マルチモデルエージェントの定義とテスト</strong></p>
<p>モデル名の文字列だけを渡す（これはGoogleのGeminiモデルにデフォルト設定されます）代わりに、目的のモデル識別子文字列を<code>LiteLlm</code>クラスでラップします。</p>
<ul>
<li><strong>重要なコンセプト：<code>LiteLlm</code>ラッパー：</strong> <code>LiteLlm(model="provider/model_name")</code>という構文は、このエージェントへのリクエストをLiteLLMライブラリ経由で指定されたモデルプロバイダーにルーティングするようADKに伝えます。</li>
</ul>
<p>ステップ0でOpenAIとAnthropicに必要なAPIキーを設定したことを確認してください。以前に定義した<code>call_agent_async</code>関数（現在は<code>runner</code>、<code>user_id</code>、<code>session_id</code>を受け入れます）を使用して、各エージェントのセットアップ直後に対話します。</p>
<p>以下の各ブロックは：</p>
<ul>
<li>特定のLiteLLMモデル（<code>MODEL_GPT_4O</code>または<code>MODEL_CLAUDE_SONNET</code>）を使用してエージェントを定義します。</li>
<li>そのエージェントのテストラン専用に、<em>新しく、別の</em><code>InMemorySessionService</code>とセッションを作成します。これにより、このデモンストレーションのために会話履歴が分離されます。</li>
<li>特定のエージェントとそのセッションサービス用に設定された<code>Runner</code>を作成します。</li>
<li>すぐに<code>call_agent_async</code>を呼び出してクエリを送信し、エージェントをテストします。</li>
</ul>
<p><strong>ベストプラクティス：</strong> タイプミスを避け、コードを管理しやすくするために、モデル名には定数（ステップ0で定義した<code>MODEL_GPT_4O</code>、<code>MODEL_CLAUDE_SONNET</code>など）を使用してください。</p>
<p><strong>エラーハンドリング：</strong> エージェントの定義を<code>try...except</code>ブロックでラップします。これにより、特定のプロバイダーのAPIキーがないか無効な場合にコードセル全体が失敗するのを防ぎ、<em>設定されている</em>モデルでチュートリアルを続行できます。</p>
<p>まず、OpenAIのGPT-4oを使用してエージェントを作成し、テストしましょう。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="c1"># @title GPTエージェントの定義とテスト</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="c1"># ステップ1の&#39;get_weather&#39;関数が環境で定義されていることを確認してください。</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="c1"># &#39;call_agent_async&#39;が以前から定義されていることを確認してください。</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="c1"># --- GPT-4oを使用するエージェント ---</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="n">weather_agent_gpt</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Noneに初期化</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="n">runner_gpt</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># runnerをNoneに初期化</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>    <span class="n">weather_agent_gpt</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_gpt&quot;</span><span class="p">,</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>        <span class="c1"># 主要な変更点：LiteLLMモデル識別子をラップする</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>        <span class="n">model</span><span class="o">=</span><span class="n">LiteLlm</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">MODEL_GPT_4O</span><span class="p">),</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;天気情報を提供します（GPT-4o使用）。&quot;</span><span class="p">,</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;あなたはGPT-4oを搭載した親切な天気アシスタントです。&quot;</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>                    <span class="s2">&quot;都市の天気の問い合わせには&#39;get_weather&#39;ツールを使用してください。&quot;</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>                    <span class="s2">&quot;ツールの出力ステータスに基づいて、成功したレポートまたは丁寧なエラーメッセージを明確に提示してください。&quot;</span><span class="p">,</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather</span><span class="p">],</span> <span class="c1"># 同じツールを再利用</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>    <span class="p">)</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;エージェント&#39;</span><span class="si">{</span><span class="n">weather_agent_gpt</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;がモデル&#39;</span><span class="si">{</span><span class="n">MODEL_GPT_4O</span><span class="si">}</span><span class="s2">&#39;を使用して作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>    <span class="c1"># InMemorySessionServiceはこのチュートリアルのための単純で非永続的なストレージです。</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>    <span class="n">session_service_gpt</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span> <span class="c1"># 専用のサービスを作成</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>    <span class="c1"># インタラクションコンテキストを識別するための定数を定義</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>    <span class="n">APP_NAME_GPT</span> <span class="o">=</span> <span class="s2">&quot;weather_tutorial_app_gpt&quot;</span> <span class="c1"># このテスト用の一意のアプリ名</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>    <span class="n">USER_ID_GPT</span> <span class="o">=</span> <span class="s2">&quot;user_1_gpt&quot;</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>    <span class="n">SESSION_ID_GPT</span> <span class="o">=</span> <span class="s2">&quot;session_001_gpt&quot;</span> <span class="c1"># 簡単のため固定IDを使用</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>    <span class="c1"># 会話が行われる特定のセッションを作成</span>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>    <span class="n">session_gpt</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_gpt</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33" href="#__codelineno-10-33"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME_GPT</span><span class="p">,</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34" href="#__codelineno-10-34"></a>        <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_GPT</span><span class="p">,</span>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35" href="#__codelineno-10-35"></a>        <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_GPT</span>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36" href="#__codelineno-10-36"></a>    <span class="p">)</span>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37" href="#__codelineno-10-37"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;セッションが作成されました：App=&#39;</span><span class="si">{</span><span class="n">APP_NAME_GPT</span><span class="si">}</span><span class="s2">&#39;, User=&#39;</span><span class="si">{</span><span class="n">USER_ID_GPT</span><span class="si">}</span><span class="s2">&#39;, Session=&#39;</span><span class="si">{</span><span class="n">SESSION_ID_GPT</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38" href="#__codelineno-10-38"></a>
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39" href="#__codelineno-10-39"></a>    <span class="c1"># このエージェントとそのセッションサービスに特化したランナーを作成</span>
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40" href="#__codelineno-10-40"></a>    <span class="n">runner_gpt</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41" href="#__codelineno-10-41"></a>        <span class="n">agent</span><span class="o">=</span><span class="n">weather_agent_gpt</span><span class="p">,</span>
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42" href="#__codelineno-10-42"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME_GPT</span><span class="p">,</span>       <span class="c1"># 特定のアプリ名を使用</span>
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43" href="#__codelineno-10-43"></a>        <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_gpt</span> <span class="c1"># 特定のセッションサービスを使用</span>
</span><span id="__span-10-44"><a id="__codelineno-10-44" name="__codelineno-10-44" href="#__codelineno-10-44"></a>        <span class="p">)</span>
</span><span id="__span-10-45"><a id="__codelineno-10-45" name="__codelineno-10-45" href="#__codelineno-10-45"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runnerがエージェント&#39;</span><span class="si">{</span><span class="n">runner_gpt</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;のために作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-10-46"><a id="__codelineno-10-46" name="__codelineno-10-46" href="#__codelineno-10-46"></a>
</span><span id="__span-10-47"><a id="__codelineno-10-47" name="__codelineno-10-47" href="#__codelineno-10-47"></a>    <span class="c1"># --- GPTエージェントのテスト ---</span>
</span><span id="__span-10-48"><a id="__codelineno-10-48" name="__codelineno-10-48" href="#__codelineno-10-48"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- GPTエージェントのテスト中 ---&quot;</span><span class="p">)</span>
</span><span id="__span-10-49"><a id="__codelineno-10-49" name="__codelineno-10-49" href="#__codelineno-10-49"></a>    <span class="c1"># call_agent_asyncが正しいrunner, user_id, session_idを使用することを確認</span>
</span><span id="__span-10-50"><a id="__codelineno-10-50" name="__codelineno-10-50" href="#__codelineno-10-50"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;東京の天気はどうですか？&quot;</span><span class="p">,</span>
</span><span id="__span-10-51"><a id="__codelineno-10-51" name="__codelineno-10-51" href="#__codelineno-10-51"></a>                           <span class="n">runner</span><span class="o">=</span><span class="n">runner_gpt</span><span class="p">,</span>
</span><span id="__span-10-52"><a id="__codelineno-10-52" name="__codelineno-10-52" href="#__codelineno-10-52"></a>                           <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_GPT</span><span class="p">,</span>
</span><span id="__span-10-53"><a id="__codelineno-10-53" name="__codelineno-10-53" href="#__codelineno-10-53"></a>                           <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_GPT</span><span class="p">)</span>
</span><span id="__span-10-54"><a id="__codelineno-10-54" name="__codelineno-10-54" href="#__codelineno-10-54"></a>    <span class="c1"># --- または ---</span>
</span><span id="__span-10-55"><a id="__codelineno-10-55" name="__codelineno-10-55" href="#__codelineno-10-55"></a>
</span><span id="__span-10-56"><a id="__codelineno-10-56" name="__codelineno-10-56" href="#__codelineno-10-56"></a>    <span class="c1"># 標準のPythonスクリプト（.pyファイル）として実行する場合は、以下の行のコメントを外してください：</span>
</span><span id="__span-10-57"><a id="__codelineno-10-57" name="__codelineno-10-57" href="#__codelineno-10-57"></a>    <span class="c1"># import asyncio</span>
</span><span id="__span-10-58"><a id="__codelineno-10-58" name="__codelineno-10-58" href="#__codelineno-10-58"></a>    <span class="c1"># if __name__ == &quot;__main__&quot;:</span>
</span><span id="__span-10-59"><a id="__codelineno-10-59" name="__codelineno-10-59" href="#__codelineno-10-59"></a>    <span class="c1">#     try:</span>
</span><span id="__span-10-60"><a id="__codelineno-10-60" name="__codelineno-10-60" href="#__codelineno-10-60"></a>    <span class="c1">#         asyncio.run(call_agent_async(query = &quot;東京の天気はどうですか？&quot;,</span>
</span><span id="__span-10-61"><a id="__codelineno-10-61" name="__codelineno-10-61" href="#__codelineno-10-61"></a>    <span class="c1">#                      runner=runner_gpt,</span>
</span><span id="__span-10-62"><a id="__codelineno-10-62" name="__codelineno-10-62" href="#__codelineno-10-62"></a>    <span class="c1">#                       user_id=USER_ID_GPT,</span>
</span><span id="__span-10-63"><a id="__codelineno-10-63" name="__codelineno-10-63" href="#__codelineno-10-63"></a>    <span class="c1">#                       session_id=SESSION_ID_GPT))</span>
</span><span id="__span-10-64"><a id="__codelineno-10-64" name="__codelineno-10-64" href="#__codelineno-10-64"></a>    <span class="c1">#     except Exception as e:</span>
</span><span id="__span-10-65"><a id="__codelineno-10-65" name="__codelineno-10-65" href="#__codelineno-10-65"></a>    <span class="c1">#         print(f&quot;エラーが発生しました：{e}&quot;)</span>
</span><span id="__span-10-66"><a id="__codelineno-10-66" name="__codelineno-10-66" href="#__codelineno-10-66"></a>
</span><span id="__span-10-67"><a id="__codelineno-10-67" name="__codelineno-10-67" href="#__codelineno-10-67"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-10-68"><a id="__codelineno-10-68" name="__codelineno-10-68" href="#__codelineno-10-68"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ GPTエージェント&#39;</span><span class="si">{</span><span class="n">MODEL_GPT_4O</span><span class="si">}</span><span class="s2">&#39;を作成または実行できませんでした。APIキーとモデル名を確認してください。エラー：</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>次に、AnthropicのClaude Sonnetで同じことを行います。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="c1"># @title Claudeエージェントの定義とテスト</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="c1"># ステップ1の&#39;get_weather&#39;関数が環境で定義されていることを確認してください。</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="c1"># &#39;call_agent_async&#39;が以前から定義されていることを確認してください。</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="c1"># --- Claude Sonnetを使用するエージェント ---</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="n">weather_agent_claude</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Noneに初期化</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="n">runner_claude</span> <span class="o">=</span> <span class="kc">None</span>      <span class="c1"># runnerをNoneに初期化</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="n">weather_agent_claude</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_claude&quot;</span><span class="p">,</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>        <span class="c1"># 主要な変更点：LiteLLMモデル識別子をラップする</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>        <span class="n">model</span><span class="o">=</span><span class="n">LiteLlm</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">MODEL_CLAUDE_SONNET</span><span class="p">),</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;天気情報を提供します（Claude Sonnet使用）。&quot;</span><span class="p">,</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;あなたはClaude Sonnetを搭載した親切な天気アシスタントです。&quot;</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>                    <span class="s2">&quot;都市の天気の問い合わせには&#39;get_weather&#39;ツールを使用してください。&quot;</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a>                    <span class="s2">&quot;ツールの辞書出力（&#39;status&#39;, &#39;report&#39;/&#39;error_message&#39;）を分析してください。&quot;</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a>                    <span class="s2">&quot;成功したレポートまたは丁寧なエラーメッセージを明確に提示してください。&quot;</span><span class="p">,</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather</span><span class="p">],</span> <span class="c1"># 同じツールを再利用</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a>    <span class="p">)</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;エージェント&#39;</span><span class="si">{</span><span class="n">weather_agent_claude</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;がモデル&#39;</span><span class="si">{</span><span class="n">MODEL_CLAUDE_SONNET</span><span class="si">}</span><span class="s2">&#39;を使用して作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a>    <span class="c1"># InMemorySessionServiceはこのチュートリアルのための単純で非永続的なストレージです。</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a>    <span class="n">session_service_claude</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span> <span class="c1"># 専用のサービスを作成</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a>    <span class="c1"># インタラクションコンテキストを識別するための定数を定義</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a>    <span class="n">APP_NAME_CLAUDE</span> <span class="o">=</span> <span class="s2">&quot;weather_tutorial_app_claude&quot;</span> <span class="c1"># 一意のアプリ名</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a>    <span class="n">USER_ID_CLAUDE</span> <span class="o">=</span> <span class="s2">&quot;user_1_claude&quot;</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a>    <span class="n">SESSION_ID_CLAUDE</span> <span class="o">=</span> <span class="s2">&quot;session_001_claude&quot;</span> <span class="c1"># 簡単のため固定IDを使用</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a>    <span class="c1"># 会話が行われる特定のセッションを作成</span>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a>    <span class="n">session_claude</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_claude</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME_CLAUDE</span><span class="p">,</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#__codelineno-11-35"></a>        <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_CLAUDE</span><span class="p">,</span>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#__codelineno-11-36"></a>        <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_CLAUDE</span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#__codelineno-11-37"></a>    <span class="p">)</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#__codelineno-11-38"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;セッションが作成されました：App=&#39;</span><span class="si">{</span><span class="n">APP_NAME_CLAUDE</span><span class="si">}</span><span class="s2">&#39;, User=&#39;</span><span class="si">{</span><span class="n">USER_ID_CLAUDE</span><span class="si">}</span><span class="s2">&#39;, Session=&#39;</span><span class="si">{</span><span class="n">SESSION_ID_CLAUDE</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="#__codelineno-11-39"></a>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="#__codelineno-11-40"></a>    <span class="c1"># このエージェントとそのセッションサービスに特化したランナーを作成</span>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="#__codelineno-11-41"></a>    <span class="n">runner_claude</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="#__codelineno-11-42"></a>        <span class="n">agent</span><span class="o">=</span><span class="n">weather_agent_claude</span><span class="p">,</span>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="#__codelineno-11-43"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME_CLAUDE</span><span class="p">,</span>       <span class="c1"># 特定のアプリ名を使用</span>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="#__codelineno-11-44"></a>        <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_claude</span> <span class="c1"># 特定のセッションサービスを使用</span>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45" href="#__codelineno-11-45"></a>        <span class="p">)</span>
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46" href="#__codelineno-11-46"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runnerがエージェント&#39;</span><span class="si">{</span><span class="n">runner_claude</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;のために作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47" href="#__codelineno-11-47"></a>
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48" href="#__codelineno-11-48"></a>    <span class="c1"># --- Claudeエージェントのテスト ---</span>
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49" href="#__codelineno-11-49"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Claudeエージェントのテスト中 ---&quot;</span><span class="p">)</span>
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50" href="#__codelineno-11-50"></a>    <span class="c1"># call_agent_asyncが正しいrunner, user_id, session_idを使用することを確認</span>
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51" href="#__codelineno-11-51"></a>    <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;ロンドンの天気を教えてください。&quot;</span><span class="p">,</span>
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52" href="#__codelineno-11-52"></a>                           <span class="n">runner</span><span class="o">=</span><span class="n">runner_claude</span><span class="p">,</span>
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53" href="#__codelineno-11-53"></a>                           <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_CLAUDE</span><span class="p">,</span>
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54" href="#__codelineno-11-54"></a>                           <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_CLAUDE</span><span class="p">)</span>
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55" href="#__codelineno-11-55"></a>
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56" href="#__codelineno-11-56"></a>    <span class="c1"># --- または ---</span>
</span><span id="__span-11-57"><a id="__codelineno-11-57" name="__codelineno-11-57" href="#__codelineno-11-57"></a>
</span><span id="__span-11-58"><a id="__codelineno-11-58" name="__codelineno-11-58" href="#__codelineno-11-58"></a>    <span class="c1"># 標準のPythonスクリプト（.pyファイル）として実行する場合は、以下の行のコメントを外してください：</span>
</span><span id="__span-11-59"><a id="__codelineno-11-59" name="__codelineno-11-59" href="#__codelineno-11-59"></a>    <span class="c1"># import asyncio</span>
</span><span id="__span-11-60"><a id="__codelineno-11-60" name="__codelineno-11-60" href="#__codelineno-11-60"></a>    <span class="c1"># if __name__ == &quot;__main__&quot;:</span>
</span><span id="__span-11-61"><a id="__codelineno-11-61" name="__codelineno-11-61" href="#__codelineno-11-61"></a>    <span class="c1">#     try:</span>
</span><span id="__span-11-62"><a id="__codelineno-11-62" name="__codelineno-11-62" href="#__codelineno-11-62"></a>    <span class="c1">#         asyncio.run(call_agent_async(query = &quot;ロンドンの天気を教えてください。&quot;,</span>
</span><span id="__span-11-63"><a id="__codelineno-11-63" name="__codelineno-11-63" href="#__codelineno-11-63"></a>    <span class="c1">#                      runner=runner_claude,</span>
</span><span id="__span-11-64"><a id="__codelineno-11-64" name="__codelineno-11-64" href="#__codelineno-11-64"></a>    <span class="c1">#                       user_id=USER_ID_CLAUDE,</span>
</span><span id="__span-11-65"><a id="__codelineno-11-65" name="__codelineno-11-65" href="#__codelineno-11-65"></a>    <span class="c1">#                       session_id=SESSION_ID_CLAUDE))</span>
</span><span id="__span-11-66"><a id="__codelineno-11-66" name="__codelineno-11-66" href="#__codelineno-11-66"></a>    <span class="c1">#     except Exception as e:</span>
</span><span id="__span-11-67"><a id="__codelineno-11-67" name="__codelineno-11-67" href="#__codelineno-11-67"></a>    <span class="c1">#         print(f&quot;エラーが発生しました：{e}&quot;)</span>
</span><span id="__span-11-68"><a id="__codelineno-11-68" name="__codelineno-11-68" href="#__codelineno-11-68"></a>
</span><span id="__span-11-69"><a id="__codelineno-11-69" name="__codelineno-11-69" href="#__codelineno-11-69"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-11-70"><a id="__codelineno-11-70" name="__codelineno-11-70" href="#__codelineno-11-70"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ Claudeエージェント&#39;</span><span class="si">{</span><span class="n">MODEL_CLAUDE_SONNET</span><span class="si">}</span><span class="s2">&#39;を作成または実行できませんでした。APIキーとモデル名を確認してください。エラー：</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<p>両方のコードブロックからの出力を注意深く見てください。以下が確認できるはずです：</p>
<ol>
<li>各エージェント（<code>weather_agent_gpt</code>、<code>weather_agent_claude</code>）が正常に作成されます（APIキーが有効な場合）。</li>
<li>それぞれに専用のセッションとランナーがセットアップされます。</li>
<li>各エージェントは、クエリを処理する際に<code>get_weather</code>ツールを使用する必要があることを正しく識別します（<code>--- ツール：get_weatherが呼び出されました... ---</code>のログが表示されます）。</li>
<li><em>基盤となるツールのロジック</em>は同一であり、常に私たちの模擬データを返します。</li>
<li>しかし、各エージェントによって生成される<strong>最終的なテキスト応答</strong>は、言い回し、トーン、またはフォーマットがわずかに異なる場合があります。これは、指示プロンプトが異なるLLM（GPT-4o対Claude Sonnet）によって解釈および実行されるためです。</li>
</ol>
<p>このステップは、ADKとLiteLLMが提供するパワーと柔軟性を示しています。コアアプリケーションロジック（ツール、基本的なエージェント構造）を一貫させながら、さまざまなLLMを使用してエージェントを簡単に実験およびデプロイできます。</p>
<p>次のステップでは、単一のエージェントを超えて、エージェントが互いにタスクを委任できる小さなチームを構築します！</p>
<hr />
<h2 id="3-">ステップ3：エージェントチームの構築 - 挨拶と別れの委任<a class="headerlink" href="#3-" title="Permanent link">&para;</a></h2>
<p>ステップ1と2では、天気の検索のみに焦点を当てた単一のエージェントを構築し、実験しました。その特定のタスクには効果的ですが、実世界のアプリケーションでは、より多様なユーザーインタラクションを処理する必要があります。単一の天気エージェントにツールを追加し続け、複雑な指示を与えることもできますが、これはすぐに管理が困難になり、効率が低下する可能性があります。</p>
<p>より堅牢なアプローチは、<strong>エージェントチーム</strong>を構築することです。これには以下が含まれます：</p>
<ol>
<li>それぞれが特定の能力（例：天気用、挨拶用、計算用）のために設計された、複数の<strong>専門エージェント</strong>を作成する。</li>
<li>最初のユーザーリクエストを受け取る<strong>ルートエージェント</strong>（またはオーケストレーター）を指定する。</li>
<li>ユーザーの意図に基づいて、ルートエージェントがリクエストを最も適切な専門サブエージェントに<strong>委任</strong>できるようにする。</li>
</ol>
<p><strong>なぜエージェントチームを構築するのか？</strong></p>
<ul>
<li><strong>モジュール性：</strong> 個々のエージェントの開発、テスト、保守が容易になります。</li>
<li><strong>専門化：</strong> 各エージェントは、その特定のタスクに合わせて（指示、モデル選択）微調整できます。</li>
<li><strong>スケーラビリティ：</strong> 新しいエージェントを追加することで、新しい機能を簡単に追加できます。</li>
<li><strong>効率性：</strong> より単純なタスク（挨拶など）には、潜在的により単純/安価なモデルを使用できます。</li>
</ul>
<p><strong>このステップでは、以下のことを行います：</strong></p>
<ol>
<li>挨拶（<code>say_hello</code>）と別れ（<code>say_goodbye</code>）を処理するための簡単なツールを定義します。</li>
<li>2つの新しい専門サブエージェントを作成します：<code>greeting_agent</code>と<code>farewell_agent</code>。</li>
<li>メインの天気エージェント（<code>weather_agent_v2</code>）を<strong>ルートエージェント</strong>として機能するように更新します。</li>
<li>ルートエージェントをそのサブエージェントで設定し、<strong>自動委任</strong>を有効にします。</li>
<li>ルートエージェントに異なるタイプのリクエストを送信して、委任フローをテストします。</li>
</ol>
<hr />
<p><strong>1. サブエージェント用のツールの定義</strong></p>
<p>まず、新しい専門エージェントのツールとして機能する簡単なPython関数を作成しましょう。明確なdocstringが、それらを使用するエージェントにとって不可欠であることを忘れないでください。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1"># @title 挨拶および別れエージェント用のツールを定義</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span> <span class="c1"># Optionalを必ずインポート</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="c1"># このステップを独立して実行する場合、ステップ1の&#39;get_weather&#39;が利用可能であることを確認してください。</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="c1"># def get_weather(city: str) -&gt; dict: ... (ステップ1から)</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="k">def</span><span class="w"> </span><span class="nf">say_hello</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;簡単な挨拶を提供します。名前が提供された場合は、それを使用します。</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="sd">    Args:</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="sd">        name (str, optional): 挨拶する人の名前。提供されない場合は、一般的な挨拶にデフォルト設定されます。</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="sd">    Returns:</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="sd">        str: 親しみやすい挨拶メッセージ。</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a>    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a>        <span class="n">greeting</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;こんにちは、</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">！&quot;</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- ツール：say_helloが名前：</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">で呼び出されました ---&quot;</span><span class="p">)</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#__codelineno-12-19"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#__codelineno-12-20"></a>        <span class="n">greeting</span> <span class="o">=</span> <span class="s2">&quot;こんにちは！&quot;</span> <span class="c1"># nameがNoneまたは明示的に渡されない場合のデフォルトの挨拶</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#__codelineno-12-21"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- ツール：say_helloが特定の名前なしで呼び出されました (name_arg_value: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">) ---&quot;</span><span class="p">)</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#__codelineno-12-22"></a>    <span class="k">return</span> <span class="n">greeting</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#__codelineno-12-23"></a>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#__codelineno-12-24"></a><span class="k">def</span><span class="w"> </span><span class="nf">say_goodbye</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#__codelineno-12-25"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;会話を締めくくるための簡単な別れのメッセージを提供します。&quot;&quot;&quot;</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#__codelineno-12-26"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- ツール：say_goodbyeが呼び出されました ---&quot;</span><span class="p">)</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#__codelineno-12-27"></a>    <span class="k">return</span> <span class="s2">&quot;さようなら！良い一日を。&quot;</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#__codelineno-12-28"></a>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#__codelineno-12-29"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;挨拶と別れのツールが定義されました。&quot;</span><span class="p">)</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#__codelineno-12-30"></a>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#__codelineno-12-31"></a><span class="c1"># オプションの自己テスト</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="#__codelineno-12-32"></a><span class="nb">print</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="s2">&quot;アリス&quot;</span><span class="p">))</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="#__codelineno-12-33"></a><span class="nb">print</span><span class="p">(</span><span class="n">say_hello</span><span class="p">())</span> <span class="c1"># 引数なしでテスト（デフォルトの「こんにちは！」を使用するはず）</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="#__codelineno-12-34"></a><span class="nb">print</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span> <span class="c1"># nameを明示的にNoneとしてテスト（デフォルトの「こんにちは！」を使用するはず）</span>
</span></code></pre></div>
<hr />
<p><strong>2. サブエージェントの定義（挨拶と別れ）</strong></p>
<p>次に、専門家たちの<code>Agent</code>インスタンスを作成します。彼らの非常に焦点の合った<code>instruction</code>と、決定的に重要な、明確な<code>description</code>に注目してください。<code>description</code>は、<em>ルートエージェント</em>がこれらのサブエージェントに<em>いつ</em>委任するかを決定するために使用する主要な情報です。</p>
<p><strong>ベストプラクティス：</strong> サブエージェントの<code>description</code>フィールドは、その特定の能力を正確かつ簡潔に要約する必要があります。これは効果的な自動委任のために非常に重要です。</p>
<p><strong>ベストプラクティス：</strong> サブエージェントの<code>instruction</code>フィールドは、その限られた範囲に合わせて調整し、何をすべきか、そして<em>何をすべきでないか</em>を正確に伝えるべきです（例：「あなたの<em>唯一の</em>タスクは...」）。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1"># @title 挨拶および別れサブエージェントの定義</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="c1"># Gemini以外のモデルを使用したい場合は、LiteLlmがインポートされ、APIキーが設定されていることを確認してください（ステップ0/2から）</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="c1"># from google.adk.models.lite_llm import LiteLlm</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="c1"># MODEL_GPT_4O, MODEL_CLAUDE_SONNETなどが定義されている必要があります</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="c1"># そうでない場合は、引き続きmodel = MODEL_GEMINI_2_0_FLASHを使用します</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="c1"># --- 挨拶エージェント ---</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="n">greeting_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>    <span class="n">greeting_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>        <span class="c1"># 簡単なタスクには潜在的に異なる/安価なモデルを使用</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>        <span class="c1"># model=LiteLlm(model=MODEL_GPT_4O), # 他のモデルで実験したい場合</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;greeting_agent&quot;</span><span class="p">,</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;あなたは挨拶エージェントです。あなたの唯一のタスクは、ユーザーに親しみやすい挨拶を提供することです。&quot;</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>                    <span class="s2">&quot;&#39;say_hello&#39;ツールを使用して挨拶を生成してください。&quot;</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>                    <span class="s2">&quot;ユーザーが名前を教えた場合は、必ずそれをツールに渡してください。&quot;</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>                    <span class="s2">&quot;他の会話やタスクには一切関与しないでください。&quot;</span><span class="p">,</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&#39;say_hello&#39;ツールを使用して簡単な挨拶を処理します。&quot;</span><span class="p">,</span> <span class="c1"># 委任に重要</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_hello</span><span class="p">],</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>    <span class="p">)</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ エージェント&#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;がモデル&#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39;を使用して作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 挨拶エージェントを作成できませんでした。APIキーを確認してください（</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">）。エラー：</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a><span class="c1"># --- 別れエージェント ---</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a><span class="n">farewell_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>    <span class="n">farewell_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>        <span class="c1"># 同じか異なるモデルを使用可能</span>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>        <span class="c1"># model=LiteLlm(model=MODEL_GPT_4O), # 他のモデルで実験したい場合</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;farewell_agent&quot;</span><span class="p">,</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;あなたは別れエージェントです。あなたの唯一のタスクは、丁寧なさようならのメッセージを提供することです。&quot;</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="#__codelineno-13-36"></a>                    <span class="s2">&quot;ユーザーが会話を終了することを示した場合（例：「バイバイ」、「さようなら」、「ありがとう、バイバイ」、「またね」など）、&quot;</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="#__codelineno-13-37"></a>                    <span class="s2">&quot;&#39;say_goodbye&#39;ツールを使用してください。&quot;</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="#__codelineno-13-38"></a>                    <span class="s2">&quot;他のアクションは一切実行しないでください。&quot;</span><span class="p">,</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39" href="#__codelineno-13-39"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&#39;say_goodbye&#39;ツールを使用して簡単な別れを処理します。&quot;</span><span class="p">,</span> <span class="c1"># 委任に重要</span>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40" href="#__codelineno-13-40"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_goodbye</span><span class="p">],</span>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41" href="#__codelineno-13-41"></a>    <span class="p">)</span>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42" href="#__codelineno-13-42"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ エージェント&#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;がモデル&#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39;を使用して作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43" href="#__codelineno-13-43"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44" href="#__codelineno-13-44"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 別れエージェントを作成できませんでした。APIキーを確認してください（</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">）。エラー：</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>3. ルートエージェントの定義（天気エージェントv2）とサブエージェント</strong></p>
<p>次に、<code>weather_agent</code>をアップグレードします。主な変更点は次のとおりです：</p>
<ul>
<li><code>sub_agents</code>パラメータの追加：作成した<code>greeting_agent</code>と<code>farewell_agent</code>のインスタンスを含むリストを渡します。</li>
<li><code>instruction</code>の更新：ルートエージェントに、そのサブエージェントについて、そして<em>いつ</em>タスクを委任すべきかを明示的に伝えます。</li>
</ul>
<p><strong>重要なコンセプト：自動委任（Auto Flow）</strong> <code>sub_agents</code>リストを提供することで、ADKは自動委任を有効にします。ルートエージェントがユーザーのクエリを受け取ると、そのLLMは自身の指示とツールだけでなく、各サブエージェントの<code>description</code>も考慮します。LLMがクエリがサブエージェントの記述された能力（例：「簡単な挨拶を処理します」）によりよく一致すると判断した場合、自動的にそのターンで<em>制御をそのサブエージェントに移す</em>ための特別な内部アクションを生成します。その後、サブエージェントは自身のモデル、指示、ツールを使用してクエリを処理します。</p>
<p><strong>ベストプラクティス：</strong> ルートエージェントの指示が、その委任決定を明確に導くようにしてください。サブエージェントを名前で言及し、委任が発生すべき条件を説明してください。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="c1"># @title サブエージェントを持つルートエージェントを定義</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="c1"># ルートエージェントを定義する前に、サブエージェントが正常に作成されたことを確認してください。</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="c1"># また、元の&#39;get_weather&#39;ツールが定義されていることを確認してください。</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="n">root_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="n">runner_root</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># runnerを初期化</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="k">if</span> <span class="n">greeting_agent</span> <span class="ow">and</span> <span class="n">farewell_agent</span> <span class="ow">and</span> <span class="s1">&#39;get_weather&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>    <span class="c1"># オーケストレーションを処理するために、ルートエージェントには高性能なGeminiモデルを使用しましょう</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a>    <span class="n">root_agent_model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>    <span class="n">weather_agent_team</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v2&quot;</span><span class="p">,</span> <span class="c1"># 新しいバージョン名を付ける</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a>        <span class="n">model</span><span class="o">=</span><span class="n">root_agent_model</span><span class="p">,</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;メインのコーディネーターエージェント。天気のリクエストを処理し、挨拶/別れを専門家に委任します。&quot;</span><span class="p">,</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#__codelineno-14-16"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;あなたはチームを調整するメインの天気エージェントです。あなたの主な責任は天気情報を提供することです。&quot;</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#__codelineno-14-17"></a>                    <span class="s2">&quot;特定の天気のリクエスト（例：「ロンドンの天気」）にのみ&#39;get_weather&#39;ツールを使用してください。&quot;</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#__codelineno-14-18"></a>                    <span class="s2">&quot;あなたには専門のサブエージェントがいます：&quot;</span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#__codelineno-14-19"></a>                    <span class="s2">&quot;1. &#39;greeting_agent&#39;: 「こんにちは」「もしもし」のような簡単な挨拶を処理します。これらには委任してください。&quot;</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#__codelineno-14-20"></a>                    <span class="s2">&quot;2. &#39;farewell_agent&#39;: 「さようなら」「またね」のような簡単な別れを処理します。これらには委任してください。&quot;</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#__codelineno-14-21"></a>                    <span class="s2">&quot;ユーザーのクエリを分析してください。それが挨拶なら&#39;greeting_agent&#39;に委任し、別れなら&#39;farewell_agent&#39;に委任してください。&quot;</span>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#__codelineno-14-22"></a>                    <span class="s2">&quot;それが天気のリクエストなら、&#39;get_weather&#39;を使って自分で処理してください。&quot;</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#__codelineno-14-23"></a>                    <span class="s2">&quot;それ以外のものについては、適切に応答するか、処理できないと述べてください。&quot;</span><span class="p">,</span>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#__codelineno-14-24"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather</span><span class="p">],</span> <span class="c1"># ルートエージェントはまだそのコアタスクのために天気ツールが必要です</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#__codelineno-14-25"></a>        <span class="c1"># 主要な変更点：ここでサブエージェントをリンクします！</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#__codelineno-14-26"></a>        <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">greeting_agent</span><span class="p">,</span> <span class="n">farewell_agent</span><span class="p">]</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#__codelineno-14-27"></a>    <span class="p">)</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#__codelineno-14-28"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ ルートエージェント&#39;</span><span class="si">{</span><span class="n">weather_agent_team</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;がモデル&#39;</span><span class="si">{</span><span class="n">root_agent_model</span><span class="si">}</span><span class="s2">&#39;とサブエージェント：</span><span class="si">{</span><span class="p">[</span><span class="n">sa</span><span class="o">.</span><span class="n">name</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">weather_agent_team</span><span class="o">.</span><span class="n">sub_agents</span><span class="p">]</span><span class="si">}</span><span class="s2">で作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#__codelineno-14-29"></a>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#__codelineno-14-30"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#__codelineno-14-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ 1つ以上のサブエージェントの初期化に失敗したか、&#39;get_weather&#39;ツールが見つからないため、ルートエージェントを作成できません。&quot;</span><span class="p">)</span>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#__codelineno-14-32"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">greeting_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - 挨拶エージェントが見つかりません。&quot;</span><span class="p">)</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#__codelineno-14-33"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">farewell_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - 別れエージェントが見つかりません。&quot;</span><span class="p">)</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="#__codelineno-14-34"></a>    <span class="k">if</span> <span class="s1">&#39;get_weather&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - get_weather関数が見つかりません。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>4. エージェントチームとの対話</strong></p>
<p>専門のサブエージェントを持つルートエージェント（<code>weather_agent_team</code> - <em>注意：この変数名が、前のコードブロック、おそらく<code># @title Define the Root Agent with Sub-Agents</code>で定義されたものと一致することを確認してください。そこでは<code>root_agent</code>と名付けられている可能性があります</em>）を定義したので、委任メカニズムをテストしましょう。</p>
<p>次のコードブロックは：</p>
<ol>
<li><code>async</code>関数<code>run_team_conversation</code>を定義します。</li>
<li>この関数内で、このテストラン専用に<em>新しく、専用の</em><code>InMemorySessionService</code>と特定のセッション（<code>session_001_agent_team</code>）を作成します。これにより、チームのダイナミクスをテストするために会話履歴が分離されます。</li>
<li>私たちの<code>weather_agent_team</code>（ルートエージェント）と専用のセッションサービスを使用するように設定された<code>Runner</code>（<code>runner_agent_team</code>）を作成します。</li>
<li>更新された<code>call_agent_async</code>関数を使用して、異なるタイプのクエリ（挨拶、天気のリクエスト、別れ）を<code>runner_agent_team</code>に送信します。この特定のテストのために、ランナー、ユーザーID、セッションIDを明示的に渡します。</li>
<li>すぐに<code>run_team_conversation</code>関数を実行します。</li>
</ol>
<p>以下のフローを期待しています：</p>
<ol>
<li>「こんにちは！」というクエリが<code>runner_agent_team</code>に送られます。</li>
<li>ルートエージェント（<code>weather_agent_team</code>）がそれを受け取り、その指示と<code>greeting_agent</code>の<code>description</code>に基づいてタスクを委任します。</li>
<li><code>greeting_agent</code>がクエリを処理し、その<code>say_hello</code>ツールを呼び出し、応答を生成します。</li>
<li>「ニューヨークの天気は？」というクエリは委任されず、ルートエージェントが直接<code>get_weather</code>ツールを使用して処理します。</li>
<li>「ありがとう、さようなら！」というクエリは<code>farewell_agent</code>に委任され、<code>say_goodbye</code>ツールが使用されます。</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="c1"># @title エージェントチームとの対話</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span> <span class="c1"># asyncioがインポートされていることを確認</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="c1"># ルートエージェント（例：前のセルの&#39;weather_agent_team&#39;または&#39;root_agent&#39;）が定義されていることを確認してください。</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="c1"># call_agent_async関数が定義されていることを確認してください。</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="c1"># 会話関数を定義する前にルートエージェント変数が存在するかチェック</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="n">root_agent_var_name</span> <span class="o">=</span> <span class="s1">&#39;root_agent&#39;</span> <span class="c1"># ステップ3のガイドのデフォルト名</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="k">if</span> <span class="s1">&#39;weather_agent_team&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="c1"># ユーザーが代わりにこの名前を使ったかチェック</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>    <span class="n">root_agent_var_name</span> <span class="o">=</span> <span class="s1">&#39;weather_agent_team&#39;</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="k">elif</span> <span class="s1">&#39;root_agent&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;⚠️ ルートエージェント（&#39;root_agent&#39;または&#39;weather_agent_team&#39;）が見つかりません。run_team_conversationを定義できません。&quot;</span><span class="p">)</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a>    <span class="c1"># コードブロックがそれでも実行される場合にNameErrorを防ぐためにダミー値を割り当てる</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>    <span class="n">root_agent</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># または実行を防ぐためのフラグを設定</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="c1"># ルートエージェントが存在する場合のみ定義して実行</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="k">if</span> <span class="n">root_agent_var_name</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">root_agent_var_name</span><span class="p">]:</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>    <span class="c1"># 会話ロジックのためのメインのasync関数を定義します。</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>    <span class="c1"># この関数内の&#39;await&#39;キーワードは非同期操作に必要です。</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_team_conversation</span><span class="p">():</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- エージェントチームの委任をテスト中 ---&quot;</span><span class="p">)</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a>        <span class="n">session_service</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>        <span class="n">APP_NAME</span> <span class="o">=</span> <span class="s2">&quot;weather_tutorial_agent_team&quot;</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>        <span class="n">USER_ID</span> <span class="o">=</span> <span class="s2">&quot;user_1_agent_team&quot;</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>        <span class="n">SESSION_ID</span> <span class="o">=</span> <span class="s2">&quot;session_001_agent_team&quot;</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>        <span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>            <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>        <span class="p">)</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;セッションが作成されました：App=&#39;</span><span class="si">{</span><span class="n">APP_NAME</span><span class="si">}</span><span class="s2">&#39;, User=&#39;</span><span class="si">{</span><span class="n">USER_ID</span><span class="si">}</span><span class="s2">&#39;, Session=&#39;</span><span class="si">{</span><span class="n">SESSION_ID</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>        <span class="n">actual_root_agent</span> <span class="o">=</span> <span class="nb">globals</span><span class="p">()[</span><span class="n">root_agent_var_name</span><span class="p">]</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#__codelineno-15-32"></a>        <span class="n">runner_agent_team</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span> <span class="c1"># またはInMemoryRunnerを使用</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#__codelineno-15-33"></a>            <span class="n">agent</span><span class="o">=</span><span class="n">actual_root_agent</span><span class="p">,</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#__codelineno-15-34"></a>            <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#__codelineno-15-35"></a>            <span class="n">session_service</span><span class="o">=</span><span class="n">session_service</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#__codelineno-15-36"></a>        <span class="p">)</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#__codelineno-15-37"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Runnerがエージェント&#39;</span><span class="si">{</span><span class="n">actual_root_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;のために作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#__codelineno-15-38"></a>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#__codelineno-15-39"></a>        <span class="c1"># --- awaitを使用したインタラクション（async def内では正しい） ---</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#__codelineno-15-40"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;こんにちは！&quot;</span><span class="p">,</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="#__codelineno-15-41"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_agent_team</span><span class="p">,</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="#__codelineno-15-42"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43" href="#__codelineno-15-43"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44" href="#__codelineno-15-44"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;ニューヨークの天気は？&quot;</span><span class="p">,</span>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45" href="#__codelineno-15-45"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_agent_team</span><span class="p">,</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46" href="#__codelineno-15-46"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47" href="#__codelineno-15-47"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48" href="#__codelineno-15-48"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;ありがとう、さようなら！&quot;</span><span class="p">,</span>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49" href="#__codelineno-15-49"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_agent_team</span><span class="p">,</span>
</span><span id="__span-15-50"><a id="__codelineno-15-50" name="__codelineno-15-50" href="#__codelineno-15-50"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID</span><span class="p">,</span>
</span><span id="__span-15-51"><a id="__codelineno-15-51" name="__codelineno-15-51" href="#__codelineno-15-51"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID</span><span class="p">)</span>
</span><span id="__span-15-52"><a id="__codelineno-15-52" name="__codelineno-15-52" href="#__codelineno-15-52"></a>
</span><span id="__span-15-53"><a id="__codelineno-15-53" name="__codelineno-15-53" href="#__codelineno-15-53"></a>    <span class="c1"># --- `run_team_conversation` async関数を実行 ---</span>
</span><span id="__span-15-54"><a id="__codelineno-15-54" name="__codelineno-15-54" href="#__codelineno-15-54"></a>    <span class="c1"># 環境に応じて以下のいずれかの方法を選択してください。</span>
</span><span id="__span-15-55"><a id="__codelineno-15-55" name="__codelineno-15-55" href="#__codelineno-15-55"></a>    <span class="c1"># 注意：これには使用するモデルのAPIキーが必要な場合があります！</span>
</span><span id="__span-15-56"><a id="__codelineno-15-56" name="__codelineno-15-56" href="#__codelineno-15-56"></a>
</span><span id="__span-15-57"><a id="__codelineno-15-57" name="__codelineno-15-57" href="#__codelineno-15-57"></a>    <span class="c1"># 方法1：直接await（ノートブック/Async REPLのデフォルト）</span>
</span><span id="__span-15-58"><a id="__codelineno-15-58" name="__codelineno-15-58" href="#__codelineno-15-58"></a>    <span class="c1"># 環境がトップレベルawaitをサポートしている場合（Colab/Jupyterノートブックなど）、</span>
</span><span id="__span-15-59"><a id="__codelineno-15-59" name="__codelineno-15-59" href="#__codelineno-15-59"></a>    <span class="c1"># イベントループが既に実行中であることを意味するので、直接関数をawaitできます。</span>
</span><span id="__span-15-60"><a id="__codelineno-15-60" name="__codelineno-15-60" href="#__codelineno-15-60"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&#39;await&#39;を使用した実行を試みています（ノートブックのデフォルト）...&quot;</span><span class="p">)</span>
</span><span id="__span-15-61"><a id="__codelineno-15-61" name="__codelineno-15-61" href="#__codelineno-15-61"></a>    <span class="k">await</span> <span class="n">run_team_conversation</span><span class="p">()</span>
</span><span id="__span-15-62"><a id="__codelineno-15-62" name="__codelineno-15-62" href="#__codelineno-15-62"></a>
</span><span id="__span-15-63"><a id="__codelineno-15-63" name="__codelineno-15-63" href="#__codelineno-15-63"></a>    <span class="c1"># 方法2：asyncio.run（標準のPythonスクリプト[.py]用）</span>
</span><span id="__span-15-64"><a id="__codelineno-15-64" name="__codelineno-15-64" href="#__codelineno-15-64"></a>    <span class="c1"># このコードをターミナルから標準のPythonスクリプトとして実行する場合、</span>
</span><span id="__span-15-65"><a id="__codelineno-15-65" name="__codelineno-15-65" href="#__codelineno-15-65"></a>    <span class="c1"># スクリプトコンテキストは同期的です。async関数を実行するためにイベントループを作成・管理するには</span>
</span><span id="__span-15-66"><a id="__codelineno-15-66" name="__codelineno-15-66" href="#__codelineno-15-66"></a>    <span class="c1"># `asyncio.run()`が必要です。</span>
</span><span id="__span-15-67"><a id="__codelineno-15-67" name="__codelineno-15-67" href="#__codelineno-15-67"></a>    <span class="c1"># この方法を使用するには：</span>
</span><span id="__span-15-68"><a id="__codelineno-15-68" name="__codelineno-15-68" href="#__codelineno-15-68"></a>    <span class="c1"># 1. 上の`await run_team_conversation()`行をコメントアウトします。</span>
</span><span id="__span-15-69"><a id="__codelineno-15-69" name="__codelineno-15-69" href="#__codelineno-15-69"></a>    <span class="c1"># 2. 以下のブロックのコメントを外します：</span>
</span><span id="__span-15-70"><a id="__codelineno-15-70" name="__codelineno-15-70" href="#__codelineno-15-70"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-15-71"><a id="__codelineno-15-71" name="__codelineno-15-71" href="#__codelineno-15-71"></a><span class="sd">    import asyncio</span>
</span><span id="__span-15-72"><a id="__codelineno-15-72" name="__codelineno-15-72" href="#__codelineno-15-72"></a><span class="sd">    if __name__ == &quot;__main__&quot;: # スクリプトが直接実行されたときのみ実行されるようにする</span>
</span><span id="__span-15-73"><a id="__codelineno-15-73" name="__codelineno-15-73" href="#__codelineno-15-73"></a><span class="sd">        print(&quot;&#39;asyncio.run()&#39;を使用した実行（標準Pythonスクリプト用）...&quot;)</span>
</span><span id="__span-15-74"><a id="__codelineno-15-74" name="__codelineno-15-74" href="#__codelineno-15-74"></a><span class="sd">        try:</span>
</span><span id="__span-15-75"><a id="__codelineno-15-75" name="__codelineno-15-75" href="#__codelineno-15-75"></a><span class="sd">            # これはイベントループを作成し、async関数を実行し、ループを閉じます。</span>
</span><span id="__span-15-76"><a id="__codelineno-15-76" name="__codelineno-15-76" href="#__codelineno-15-76"></a><span class="sd">            asyncio.run(run_team_conversation())</span>
</span><span id="__span-15-77"><a id="__codelineno-15-77" name="__codelineno-15-77" href="#__codelineno-15-77"></a><span class="sd">        except Exception as e:</span>
</span><span id="__span-15-78"><a id="__codelineno-15-78" name="__codelineno-15-78" href="#__codelineno-15-78"></a><span class="sd">            print(f&quot;エラーが発生しました：{e}&quot;)</span>
</span><span id="__span-15-79"><a id="__codelineno-15-79" name="__codelineno-15-79" href="#__codelineno-15-79"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-15-80"><a id="__codelineno-15-80" name="__codelineno-15-80" href="#__codelineno-15-80"></a>
</span><span id="__span-15-81"><a id="__codelineno-15-81" name="__codelineno-15-81" href="#__codelineno-15-81"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-15-82"><a id="__codelineno-15-82" name="__codelineno-15-82" href="#__codelineno-15-82"></a>    <span class="c1"># このメッセージは、ルートエージェント変数が見つからなかった場合に表示されます</span>
</span><span id="__span-15-83"><a id="__codelineno-15-83" name="__codelineno-15-83" href="#__codelineno-15-83"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ 前のステップでルートエージェントが正常に定義されなかったため、エージェントチームの会話実行をスキップします。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p>出力ログ、特に<code>--- ツール：...が呼び出されました ---</code>メッセージをよく見てください。以下が観察できるはずです：</p>
<ul>
<li>「こんにちは！」に対して、<code>say_hello</code>ツールが呼び出されました（<code>greeting_agent</code>が処理したことを示します）。</li>
<li>「ニューヨークの天気は？」に対して、<code>get_weather</code>ツールが呼び出されました（ルートエージェントが処理したことを示します）。</li>
<li>「ありがとう、さようなら！」に対して、<code>say_goodbye</code>ツールが呼び出されました（<code>farewell_agent</code>が処理したことを示します）。</li>
</ul>
<p>これは、<strong>自動委任</strong>が成功したことを確認します！ルートエージェントは、その指示と<code>sub_agents</code>の<code>description</code>に導かれ、ユーザーリクエストをチーム内の適切な専門エージェントに正しくルーティングしました。</p>
<p>これで、複数の協力するエージェントを持つアプリケーションを構築しました。このモジュール設計は、より複雑で能力の高いエージェントシステムを構築するための基本です。次のステップでは、セッション状態を使用してエージェントがターンを越えて情報を記憶する能力を与えます。</p>
<h2 id="4">ステップ4：セッション状態でメモリとパーソナライズを追加する<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<p>これまでのところ、私たちのエージェントチームは委任を通じてさまざまなタスクを処理できますが、各インタラクションはゼロから始まります。つまり、エージェントはセッション内の過去の会話やユーザーの好みを記憶していません。より洗練された、文脈を意識した体験を創出するためには、エージェントに<strong>メモリ</strong>が必要です。ADKは<strong>セッション状態</strong>を通じてこれを提供します。</p>
<p><strong>セッション状態とは？</strong></p>
<ul>
<li>特定のユーザーセッション（<code>APP_NAME</code>、<code>USER_ID</code>、<code>SESSION_ID</code>で識別）に紐づけられたPython辞書（<code>session.state</code>）です。</li>
<li>そのセッション内の<em>複数の会話ターン</em>にわたって情報を<strong>永続化</strong>します。</li>
<li>エージェントとツールはこの状態を読み書きでき、詳細を記憶したり、振る舞いを適応させたり、応答をパーソナライズしたりできます。</li>
</ul>
<p><strong>エージェントが状態と対話する方法：</strong></p>
<ol>
<li><strong><code>ToolContext</code>（主要な方法）：</strong> ツールは<code>ToolContext</code>オブジェクトを受け取ることができます（最後の引数として宣言されている場合、ADKによって自動的に提供されます）。このオブジェクトは<code>tool_context.state</code>を介してセッション状態への直接アクセスを提供し、ツールが実行<em>中</em>に設定を読み取ったり、結果を保存したりできるようにします。</li>
<li><strong><code>output_key</code>（エージェント応答の自動保存）：</strong> <code>Agent</code>は<code>output_key="your_key"</code>で設定できます。これにより、ADKはターンのエージェントの最終的なテキスト応答を<code>session.state["your_key"]</code>に自動的に保存します。</li>
</ol>
<p><strong>このステップでは、天気ボットチームを次のように強化します：</strong></p>
<ol>
<li>状態を分離して示すために<strong>新しい</strong><code>InMemorySessionService</code>を使用します。</li>
<li><code>temperature_unit</code>のユーザー設定でセッション状態を初期化します。</li>
<li>この設定を<code>ToolContext</code>を介して読み取り、出力形式（摂氏/華氏）を調整する、状態を意識したバージョンの天気ツール（<code>get_weather_stateful</code>）を作成します。</li>
<li>この状態対応ツールを使用するようにルートエージェントを更新し、<code>output_key</code>を設定して最終的な天気予報をセッション状態に自動的に保存するようにします。</li>
<li>会話を実行して、初期状態がツールにどのように影響するか、手動での状態変更が後続の振る舞いをどのように変えるか、そして<code>output_key</code>がエージェントの応答をどのように永続化するかを観察します。</li>
</ol>
<hr />
<p><strong>1. 新しいセッションサービスと状態の初期化</strong></p>
<p>以前のステップからの干渉なしに状態管理を明確に示すため、新しい<code>InMemorySessionService</code>をインスタンス化します。また、ユーザーの好みの温度単位を定義する初期状態でセッションを作成します。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1"># @title 1. 新しいセッションサービスと状態の初期化</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="c1"># 必要なセッションコンポーネントをインポート</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.sessions</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemorySessionService</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="c1"># この状態デモンストレーションのために新しいセッションサービスインスタンスを作成</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="n">session_service_stateful</span> <span class="o">=</span> <span class="n">InMemorySessionService</span><span class="p">()</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ 状態デモンストレーション用に新しいInMemorySessionServiceが作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="c1"># このチュートリアルのこの部分のために新しいセッションIDを定義</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="n">SESSION_ID_STATEFUL</span> <span class="o">=</span> <span class="s2">&quot;session_state_demo_001&quot;</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="n">USER_ID_STATEFUL</span> <span class="o">=</span> <span class="s2">&quot;user_state_demo&quot;</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="c1"># 初期状態データを定義 - ユーザーは最初に摂氏を好む</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="n">initial_state</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a>    <span class="s2">&quot;user_preference_temperature_unit&quot;</span><span class="p">:</span> <span class="s2">&quot;Celsius&quot;</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="p">}</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="c1"># 初期状態を提供してセッションを作成</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="n">session_stateful</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>    <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span> <span class="c1"># 一貫したアプリ名を使用</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a>    <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>    <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a>    <span class="n">state</span><span class="o">=</span><span class="n">initial_state</span> <span class="c1"># &lt;&lt;&lt; 作成時に状態を初期化</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="p">)</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ セッション&#39;</span><span class="si">{</span><span class="n">SESSION_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39;がユーザー&#39;</span><span class="si">{</span><span class="n">USER_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39;のために作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="c1"># 初期状態が正しく設定されたことを確認</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="n">retrieved_session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a>                                                         <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a>                                                         <span class="n">session_id</span> <span class="o">=</span> <span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- 初期セッション状態 ---&quot;</span><span class="p">)</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="k">if</span> <span class="n">retrieved_session</span><span class="p">:</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">retrieved_session</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;エラー：セッションを取得できませんでした。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>2. 状態対応の天気ツールを作成 (<code>get_weather_stateful</code>)</strong></p>
<p>次に、新しいバージョンの天気ツールを作成します。その主な特徴は、<code>tool_context: ToolContext</code>を受け入れることで、<code>tool_context.state</code>にアクセスできるようになることです。<code>user_preference_temperature_unit</code>を読み取り、それに応じて温度をフォーマットします。</p>
<ul>
<li>
<p><strong>重要なコンセプト：<code>ToolContext</code></strong> このオブジェクトは、ツールロジックがセッションのコンテキスト（状態変数の読み書きを含む）と対話できるようにする橋渡しです。ツール関数の最後のパラメータとして定義されていれば、ADKが自動的に注入します。</p>
</li>
<li>
<p><strong>ベストプラクティス：</strong> 状態から読み取る際は、<code>dictionary.get('key', default_value)</code>を使用して、キーが存在しない場合に対応し、ツールがクラッシュしないようにしてください。</p>
</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.tools.tool_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolContext</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_weather_stateful</span><span class="p">(</span><span class="n">city</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;天気を取得し、セッション状態に基づいて温度単位を変換します。&quot;&quot;&quot;</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- ツール：get_weather_statefulが</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">で呼び出されました ---&quot;</span><span class="p">)</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>    <span class="c1"># --- 状態から設定を読み取る ---</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>    <span class="n">preferred_unit</span> <span class="o">=</span> <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_preference_temperature_unit&quot;</span><span class="p">,</span> <span class="s2">&quot;Celsius&quot;</span><span class="p">)</span> <span class="c1"># デフォルトは摂氏</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- ツール：状態&#39;user_preference_temperature_unit&#39;を読み取り中：</span><span class="si">{</span><span class="n">preferred_unit</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a>    <span class="n">city_normalized</span> <span class="o">=</span> <span class="n">city</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a>    <span class="c1"># 模擬的な天気データ（内部では常に摂氏で保存）</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a>    <span class="n">mock_weather_db</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>        <span class="s2">&quot;newyork&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;sunny&quot;</span><span class="p">},</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a>        <span class="s2">&quot;london&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;cloudy&quot;</span><span class="p">},</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a>        <span class="s2">&quot;tokyo&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;temp_c&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="s2">&quot;light rain&quot;</span><span class="p">},</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a>    <span class="p">}</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a>    <span class="k">if</span> <span class="n">city_normalized</span> <span class="ow">in</span> <span class="n">mock_weather_db</span><span class="p">:</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">mock_weather_db</span><span class="p">[</span><span class="n">city_normalized</span><span class="p">]</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a>        <span class="n">temp_c</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;temp_c&quot;</span><span class="p">]</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a>        <span class="n">condition</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a>        <span class="c1"># 状態の設定に基づいて温度をフォーマット</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a>        <span class="k">if</span> <span class="n">preferred_unit</span> <span class="o">==</span> <span class="s2">&quot;Fahrenheit&quot;</span><span class="p">:</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a>            <span class="n">temp_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">temp_c</span> <span class="o">*</span> <span class="mi">9</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span> <span class="c1"># 華氏を計算</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a>            <span class="n">temp_unit</span> <span class="o">=</span> <span class="s2">&quot;°F&quot;</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># デフォルトは摂氏</span>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a>            <span class="n">temp_value</span> <span class="o">=</span> <span class="n">temp_c</span>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a>            <span class="n">temp_unit</span> <span class="o">=</span> <span class="s2">&quot;°C&quot;</span>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a>
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a>        <span class="n">report</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">city</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">の天気は</span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s2">で、気温は</span><span class="si">{</span><span class="n">temp_value</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}{</span><span class="n">temp_unit</span><span class="si">}</span><span class="s2">です。&quot;</span>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">:</span> <span class="n">report</span><span class="p">}</span>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- ツール：</span><span class="si">{</span><span class="n">preferred_unit</span><span class="si">}</span><span class="s2">でレポートを生成しました。結果：</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a>
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a>        <span class="c1"># 状態への書き込み例（このツールではオプション）</span>
</span><span id="__span-17-38"><a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a>        <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;last_city_checked_stateful&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">city</span>
</span><span id="__span-17-39"><a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- ツール：状態&#39;last_city_checked_stateful&#39;を更新しました：</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a>
</span><span id="__span-17-41"><a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-17-42"><a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-17-43"><a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a>        <span class="c1"># 都市が見つからない場合を処理</span>
</span><span id="__span-17-44"><a id="__codelineno-17-44" name="__codelineno-17-44" href="#__codelineno-17-44"></a>        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;申し訳ありませんが、&#39;</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">&#39;の天気情報はありません。&quot;</span>
</span><span id="__span-17-45"><a id="__codelineno-17-45" name="__codelineno-17-45" href="#__codelineno-17-45"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- ツール：都市&#39;</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">&#39;が見つかりませんでした。 ---&quot;</span><span class="p">)</span>
</span><span id="__span-17-46"><a id="__codelineno-17-46" name="__codelineno-17-46" href="#__codelineno-17-46"></a>        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}</span>
</span><span id="__span-17-47"><a id="__codelineno-17-47" name="__codelineno-17-47" href="#__codelineno-17-47"></a>
</span><span id="__span-17-48"><a id="__codelineno-17-48" name="__codelineno-17-48" href="#__codelineno-17-48"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ 状態対応の&#39;get_weather_stateful&#39;ツールが定義されました。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>3. サブエージェントの再定義とルートエージェントの更新</strong></p>
<p>このステップが自己完結型で正しく構築されるように、まずステップ3と全く同じように<code>greeting_agent</code>と<code>farewell_agent</code>を再定義します。次に、新しいルートエージェント（<code>weather_agent_v4_stateful</code>）を定義します：</p>
<ul>
<li>新しい<code>get_weather_stateful</code>ツールを使用します。</li>
<li>委任のために挨拶と別れのサブエージェントを含みます。</li>
<li><strong>重要なこと</strong>に、<code>output_key="last_weather_report"</code>を設定し、最終的な天気応答をセッション状態に自動的に保存します。</li>
</ul>
<div class="language-python highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1"># @title 3. サブエージェントの再定義とoutput_keyを持つルートエージェントの更新</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="c1"># 必要なインポートを確認：Agent, LiteLlm, Runner</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">Agent</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.lite_llm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LiteLlm</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.runners</span><span class="w"> </span><span class="kn">import</span> <span class="n">Runner</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="c1"># &#39;say_hello&#39;, &#39;say_goodbye&#39;ツールが定義されていることを確認（ステップ3から）</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="c1"># モデル定数MODEL_GPT_4O, MODEL_GEMINI_2_0_FLASHなどが定義されていることを確認</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="c1"># --- 挨拶エージェントの再定義（ステップ3から） ---</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="n">greeting_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a>    <span class="n">greeting_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a>        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;greeting_agent&quot;</span><span class="p">,</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;あなたは挨拶エージェントです。あなたの唯一のタスクは&#39;say_hello&#39;ツールを使って親しみやすい挨拶を提供することです。他には何もしないでください。&quot;</span><span class="p">,</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&#39;say_hello&#39;ツールを使用して簡単な挨拶を処理します。&quot;</span><span class="p">,</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_hello</span><span class="p">],</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a>    <span class="p">)</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ エージェント&#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;が再定義されました。&quot;</span><span class="p">)</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 挨拶エージェントを再定義できませんでした。エラー：</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="c1"># --- 別れエージェントの再定義（ステップ3から） ---</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="n">farewell_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a>    <span class="n">farewell_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a>        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;farewell_agent&quot;</span><span class="p">,</span>
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;あなたは別れエージェントです。あなたの唯一のタスクは&#39;say_goodbye&#39;ツールを使って丁寧なさようならのメッセージを提供することです。他のアクションは実行しないでください。&quot;</span><span class="p">,</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&#39;say_goodbye&#39;ツールを使用して簡単な別れを処理します。&quot;</span><span class="p">,</span>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_goodbye</span><span class="p">],</span>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33" href="#__codelineno-18-33"></a>    <span class="p">)</span>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34" href="#__codelineno-18-34"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ エージェント&#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;が再定義されました。&quot;</span><span class="p">)</span>
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35" href="#__codelineno-18-35"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36" href="#__codelineno-18-36"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 別れエージェントを再定義できませんでした。エラー：</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-18-37"><a id="__codelineno-18-37" name="__codelineno-18-37" href="#__codelineno-18-37"></a>
</span><span id="__span-18-38"><a id="__codelineno-18-38" name="__codelineno-18-38" href="#__codelineno-18-38"></a><span class="c1"># --- 更新されたルートエージェントの定義 ---</span>
</span><span id="__span-18-39"><a id="__codelineno-18-39" name="__codelineno-18-39" href="#__codelineno-18-39"></a><span class="n">root_agent_stateful</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-18-40"><a id="__codelineno-18-40" name="__codelineno-18-40" href="#__codelineno-18-40"></a><span class="n">runner_root_stateful</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># runnerを初期化</span>
</span><span id="__span-18-41"><a id="__codelineno-18-41" name="__codelineno-18-41" href="#__codelineno-18-41"></a>
</span><span id="__span-18-42"><a id="__codelineno-18-42" name="__codelineno-18-42" href="#__codelineno-18-42"></a><span class="c1"># ルートエージェントを作成する前の前提条件をチェック</span>
</span><span id="__span-18-43"><a id="__codelineno-18-43" name="__codelineno-18-43" href="#__codelineno-18-43"></a><span class="k">if</span> <span class="n">greeting_agent</span> <span class="ow">and</span> <span class="n">farewell_agent</span> <span class="ow">and</span> <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-18-44"><a id="__codelineno-18-44" name="__codelineno-18-44" href="#__codelineno-18-44"></a>
</span><span id="__span-18-45"><a id="__codelineno-18-45" name="__codelineno-18-45" href="#__codelineno-18-45"></a>    <span class="n">root_agent_model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span> <span class="c1"># オーケストレーションモデルを選択</span>
</span><span id="__span-18-46"><a id="__codelineno-18-46" name="__codelineno-18-46" href="#__codelineno-18-46"></a>
</span><span id="__span-18-47"><a id="__codelineno-18-47" name="__codelineno-18-47" href="#__codelineno-18-47"></a>    <span class="n">root_agent_stateful</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-18-48"><a id="__codelineno-18-48" name="__codelineno-18-48" href="#__codelineno-18-48"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v4_stateful&quot;</span><span class="p">,</span> <span class="c1"># 新しいバージョン名</span>
</span><span id="__span-18-49"><a id="__codelineno-18-49" name="__codelineno-18-49" href="#__codelineno-18-49"></a>        <span class="n">model</span><span class="o">=</span><span class="n">root_agent_model</span><span class="p">,</span>
</span><span id="__span-18-50"><a id="__codelineno-18-50" name="__codelineno-18-50" href="#__codelineno-18-50"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;メインエージェント：天気を提供し（状態対応の単位）、挨拶/別れを委任し、レポートを状態に保存します。&quot;</span><span class="p">,</span>
</span><span id="__span-18-51"><a id="__codelineno-18-51" name="__codelineno-18-51" href="#__codelineno-18-51"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;あなたはメインの天気エージェントです。あなたの仕事は&#39;get_weather_stateful&#39;を使って天気を提供することです。&quot;</span>
</span><span id="__span-18-52"><a id="__codelineno-18-52" name="__codelineno-18-52" href="#__codelineno-18-52"></a>                    <span class="s2">&quot;ツールは状態に保存されているユーザーの好みに基づいて温度をフォーマットします。&quot;</span>
</span><span id="__span-18-53"><a id="__codelineno-18-53" name="__codelineno-18-53" href="#__codelineno-18-53"></a>                    <span class="s2">&quot;簡単な挨拶は&#39;greeting_agent&#39;に、別れは&#39;farewell_agent&#39;に委任してください。&quot;</span>
</span><span id="__span-18-54"><a id="__codelineno-18-54" name="__codelineno-18-54" href="#__codelineno-18-54"></a>                    <span class="s2">&quot;天気のリクエスト、挨拶、別れのみを処理してください。&quot;</span><span class="p">,</span>
</span><span id="__span-18-55"><a id="__codelineno-18-55" name="__codelineno-18-55" href="#__codelineno-18-55"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather_stateful</span><span class="p">],</span> <span class="c1"># 状態対応ツールを使用</span>
</span><span id="__span-18-56"><a id="__codelineno-18-56" name="__codelineno-18-56" href="#__codelineno-18-56"></a>        <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">greeting_agent</span><span class="p">,</span> <span class="n">farewell_agent</span><span class="p">],</span> <span class="c1"># サブエージェントを含める</span>
</span><span id="__span-18-57"><a id="__codelineno-18-57" name="__codelineno-18-57" href="#__codelineno-18-57"></a>        <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;last_weather_report&quot;</span> <span class="c1"># &lt;&lt;&lt; エージェントの最終的な天気応答を自動保存</span>
</span><span id="__span-18-58"><a id="__codelineno-18-58" name="__codelineno-18-58" href="#__codelineno-18-58"></a>    <span class="p">)</span>
</span><span id="__span-18-59"><a id="__codelineno-18-59" name="__codelineno-18-59" href="#__codelineno-18-59"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ ルートエージェント&#39;</span><span class="si">{</span><span class="n">root_agent_stateful</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;が状態対応ツールとoutput_keyで作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-18-60"><a id="__codelineno-18-60" name="__codelineno-18-60" href="#__codelineno-18-60"></a>
</span><span id="__span-18-61"><a id="__codelineno-18-61" name="__codelineno-18-61" href="#__codelineno-18-61"></a>    <span class="c1"># --- このルートエージェントと新しいセッションサービスのためのRunnerを作成 ---</span>
</span><span id="__span-18-62"><a id="__codelineno-18-62" name="__codelineno-18-62" href="#__codelineno-18-62"></a>    <span class="n">runner_root_stateful</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-18-63"><a id="__codelineno-18-63" name="__codelineno-18-63" href="#__codelineno-18-63"></a>        <span class="n">agent</span><span class="o">=</span><span class="n">root_agent_stateful</span><span class="p">,</span>
</span><span id="__span-18-64"><a id="__codelineno-18-64" name="__codelineno-18-64" href="#__codelineno-18-64"></a>        <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-18-65"><a id="__codelineno-18-65" name="__codelineno-18-65" href="#__codelineno-18-65"></a>        <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_stateful</span> <span class="c1"># 新しい状態対応セッションサービスを使用</span>
</span><span id="__span-18-66"><a id="__codelineno-18-66" name="__codelineno-18-66" href="#__codelineno-18-66"></a>    <span class="p">)</span>
</span><span id="__span-18-67"><a id="__codelineno-18-67" name="__codelineno-18-67" href="#__codelineno-18-67"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ 状態対応ルートエージェント&#39;</span><span class="si">{</span><span class="n">runner_root_stateful</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;用のRunnerが状態対応セッションサービスを使用して作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-18-68"><a id="__codelineno-18-68" name="__codelineno-18-68" href="#__codelineno-18-68"></a>
</span><span id="__span-18-69"><a id="__codelineno-18-69" name="__codelineno-18-69" href="#__codelineno-18-69"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-18-70"><a id="__codelineno-18-70" name="__codelineno-18-70" href="#__codelineno-18-70"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ 状態対応ルートエージェントを作成できません。前提条件がありません。&quot;</span><span class="p">)</span>
</span><span id="__span-18-71"><a id="__codelineno-18-71" name="__codelineno-18-71" href="#__codelineno-18-71"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">greeting_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - greeting_agentの定義がありません。&quot;</span><span class="p">)</span>
</span><span id="__span-18-72"><a id="__codelineno-18-72" name="__codelineno-18-72" href="#__codelineno-18-72"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">farewell_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - farewell_agentの定義がありません。&quot;</span><span class="p">)</span>
</span><span id="__span-18-73"><a id="__codelineno-18-73" name="__codelineno-18-73" href="#__codelineno-18-73"></a>    <span class="k">if</span> <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; - get_weather_statefulツールがありません。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>4. 対話して状態フローをテストする</strong></p>
<p>さて、状態の相互作用をテストするために設計された会話を、<code>runner_root_stateful</code>（私たちの状態対応エージェントと<code>session_service_stateful</code>に関連付けられている）を使用して実行しましょう。以前に定義した<code>call_agent_async</code>関数を使用し、正しいランナー、ユーザーID（<code>USER_ID_STATEFUL</code>）、セッションID（<code>SESSION_ID_STATEFUL</code>）を渡すことを確認します。</p>
<p>会話のフローは次のようになります：</p>
<ol>
<li><strong>天気の確認（ロンドン）：</strong> <code>get_weather_stateful</code>ツールは、セクション1で初期化されたセッション状態から初期の「摂氏」設定を読み取るはずです。ルートエージェントの最終応答（摂氏での天気予報）は、<code>output_key</code>設定を介して<code>state['last_weather_report']</code>に保存されるはずです。</li>
<li><strong>状態の手動更新：</strong> <code>InMemorySessionService</code>インスタンス（<code>session_service_stateful</code>）内に保存されている状態を<em>直接変更</em>します。<ul>
<li><strong>なぜ直接変更するのか？</strong> <code>session_service.get_session()</code>メソッドはセッションの<em>コピー</em>を返します。そのコピーを変更しても、後続のエージェント実行で使用される状態には影響しません。<code>InMemorySessionService</code>でのこのテストシナリオでは、内部の<code>sessions</code>辞書にアクセスして、<code>user_preference_temperature_unit</code>の<em>実際に</em>保存されている状態値を「華氏」に変更します。<em>注意：実際のアプリケーションでは、状態の変更は通常、ツールや<code>EventActions(state_delta=...)</code>を返すエージェントロジックによってトリガーされ、手動での直接更新ではありません。</em></li>
</ul>
</li>
<li><strong>再度天気の確認（ニューヨーク）：</strong> <code>get_weather_stateful</code>ツールは、今度は状態から更新された「華氏」設定を読み取り、それに応じて温度を変換するはずです。ルートエージェントの<em>新しい</em>応答（華氏での天気）は、<code>output_key</code>のために<code>state['last_weather_report']</code>の前の値を上書きします。</li>
<li><strong>エージェントに挨拶する：</strong> <code>greeting_agent</code>への委任が状態操作と並行して正しく機能することを確認します。このインタラクションは、この特定のシーケンスで<code>output_key</code>によって保存される<em>最後の</em>応答になります。</li>
<li><strong>最終状態の検査：</strong> 会話の後、セッションをもう一度取得し（コピーを取得）、その状態を出力して、<code>user_preference_temperature_unit</code>が確かに「華氏」であることを確認し、<code>output_key</code>によって保存された最終値（この実行では挨拶になります）を観察し、ツールによって書き込まれた<code>last_city_checked_stateful</code>の値を確認します。</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="c1"># @title 4. 対話して状態フローとoutput_keyをテストする</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span> <span class="c1"># asyncioがインポートされていることを確認</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="c1"># 前のセルから状態対応ランナー（runner_root_stateful）が利用可能であることを確認</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="c1"># call_agent_async, USER_ID_STATEFUL, SESSION_ID_STATEFUL, APP_NAMEが定義されていることを確認</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="k">if</span> <span class="s1">&#39;runner_root_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">runner_root_stateful</span><span class="p">:</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>    <span class="c1"># 状態対応会話ロジックのためのメインのasync関数を定義します。</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>    <span class="c1"># この関数内の&#39;await&#39;キーワードは非同期操作に必要です。</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_stateful_conversation</span><span class="p">():</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- 状態のテスト：温度単位の変換とoutput_key ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>        <span class="c1"># 1. 天気の確認（初期状態を使用：摂氏）</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- ターン1：ロンドンの天気をリクエスト（摂氏を期待） ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="o">=</span> <span class="s2">&quot;ロンドンの天気は？&quot;</span><span class="p">,</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_root_stateful</span><span class="p">,</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>                              <span class="p">)</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>        <span class="c1"># 2. 状態設定を手動で華氏に更新 - ストレージを直接変更</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- 状態の手動更新：単位を華氏に設定 ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a>            <span class="c1"># 内部ストレージに直接アクセス - これはテスト用のInMemorySessionServiceに特有です</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a>            <span class="c1"># 注意：永続的なサービス（データベース、VertexAI）を使用した本番環境では、</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a>            <span class="c1"># 通常、内部ストレージの直接操作ではなく、エージェントのアクションや</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a>            <span class="c1"># 利用可能な場合は特定のサービスAPIを介して状態を更新します。</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a>            <span class="n">stored_session</span> <span class="o">=</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">sessions</span><span class="p">[</span><span class="n">APP_NAME</span><span class="p">][</span><span class="n">USER_ID_STATEFUL</span><span class="p">][</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">]</span>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a>            <span class="n">stored_session</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;user_preference_temperature_unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Fahrenheit&quot;</span>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a>            <span class="c1"># オプション：何らかのロジックがタイムスタンプに依存する場合は、タイムスタンプも更新したいかもしれません</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a>            <span class="c1"># import time</span>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a>            <span class="c1"># stored_session.last_update_time = time.time()</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- 保存されたセッション状態が更新されました。現在の&#39;user_preference_temperature_unit&#39;：</span><span class="si">{</span><span class="n">stored_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;設定されていません&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span> <span class="c1"># 安全のため.get()を追加</span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- エラー：アプリ&#39;</span><span class="si">{</span><span class="n">APP_NAME</span><span class="si">}</span><span class="s2">&#39;のユーザー&#39;</span><span class="si">{</span><span class="n">USER_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39;のセッション&#39;</span><span class="si">{</span><span class="n">SESSION_ID_STATEFUL</span><span class="si">}</span><span class="s2">&#39;を内部ストレージから取得して状態を更新できませんでした。IDとセッションが作成されたか確認してください。 ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a>             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- 内部セッション状態の更新中にエラーが発生しました：</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a>        <span class="c1"># 3. 再度天気の確認（ツールは華氏を使用するはず）</span>
</span><span id="__span-19-40"><a id="__codelineno-19-40" name="__codelineno-19-40" href="#__codelineno-19-40"></a>        <span class="c1"># これもoutput_keyを介して&#39;last_weather_report&#39;を更新します</span>
</span><span id="__span-19-41"><a id="__codelineno-19-41" name="__codelineno-19-41" href="#__codelineno-19-41"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- ターン2：ニューヨークの天気をリクエスト（華氏を期待） ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-42"><a id="__codelineno-19-42" name="__codelineno-19-42" href="#__codelineno-19-42"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="o">=</span> <span class="s2">&quot;ニューヨークの天気を教えて。&quot;</span><span class="p">,</span>
</span><span id="__span-19-43"><a id="__codelineno-19-43" name="__codelineno-19-43" href="#__codelineno-19-43"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_root_stateful</span><span class="p">,</span>
</span><span id="__span-19-44"><a id="__codelineno-19-44" name="__codelineno-19-44" href="#__codelineno-19-44"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-19-45"><a id="__codelineno-19-45" name="__codelineno-19-45" href="#__codelineno-19-45"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span>
</span><span id="__span-19-46"><a id="__codelineno-19-46" name="__codelineno-19-46" href="#__codelineno-19-46"></a>                              <span class="p">)</span>
</span><span id="__span-19-47"><a id="__codelineno-19-47" name="__codelineno-19-47" href="#__codelineno-19-47"></a>
</span><span id="__span-19-48"><a id="__codelineno-19-48" name="__codelineno-19-48" href="#__codelineno-19-48"></a>        <span class="c1"># 4. 基本的な委任のテスト（まだ機能するはず）</span>
</span><span id="__span-19-49"><a id="__codelineno-19-49" name="__codelineno-19-49" href="#__codelineno-19-49"></a>        <span class="c1"># これにより&#39;last_weather_report&#39;が再度更新され、NYの天気予報が上書きされます</span>
</span><span id="__span-19-50"><a id="__codelineno-19-50" name="__codelineno-19-50" href="#__codelineno-19-50"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- ターン3：挨拶を送信 ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-51"><a id="__codelineno-19-51" name="__codelineno-19-51" href="#__codelineno-19-51"></a>        <span class="k">await</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="o">=</span> <span class="s2">&quot;こんにちは！&quot;</span><span class="p">,</span>
</span><span id="__span-19-52"><a id="__codelineno-19-52" name="__codelineno-19-52" href="#__codelineno-19-52"></a>                               <span class="n">runner</span><span class="o">=</span><span class="n">runner_root_stateful</span><span class="p">,</span>
</span><span id="__span-19-53"><a id="__codelineno-19-53" name="__codelineno-19-53" href="#__codelineno-19-53"></a>                               <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-19-54"><a id="__codelineno-19-54" name="__codelineno-19-54" href="#__codelineno-19-54"></a>                               <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span>
</span><span id="__span-19-55"><a id="__codelineno-19-55" name="__codelineno-19-55" href="#__codelineno-19-55"></a>                              <span class="p">)</span>
</span><span id="__span-19-56"><a id="__codelineno-19-56" name="__codelineno-19-56" href="#__codelineno-19-56"></a>
</span><span id="__span-19-57"><a id="__codelineno-19-57" name="__codelineno-19-57" href="#__codelineno-19-57"></a>    <span class="c1"># --- `run_stateful_conversation` async関数を実行 ---</span>
</span><span id="__span-19-58"><a id="__codelineno-19-58" name="__codelineno-19-58" href="#__codelineno-19-58"></a>    <span class="c1"># 環境に応じて以下のいずれかの方法を選択してください。</span>
</span><span id="__span-19-59"><a id="__codelineno-19-59" name="__codelineno-19-59" href="#__codelineno-19-59"></a>
</span><span id="__span-19-60"><a id="__codelineno-19-60" name="__codelineno-19-60" href="#__codelineno-19-60"></a>    <span class="c1"># 方法1：直接await（ノートブック/Async REPLのデフォルト）</span>
</span><span id="__span-19-61"><a id="__codelineno-19-61" name="__codelineno-19-61" href="#__codelineno-19-61"></a>    <span class="c1"># 環境がトップレベルawaitをサポートしている場合（Colab/Jupyterノートブックなど）、</span>
</span><span id="__span-19-62"><a id="__codelineno-19-62" name="__codelineno-19-62" href="#__codelineno-19-62"></a>    <span class="c1"># イベントループが既に実行中であることを意味するので、直接関数をawaitできます。</span>
</span><span id="__span-19-63"><a id="__codelineno-19-63" name="__codelineno-19-63" href="#__codelineno-19-63"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&#39;await&#39;を使用した実行を試みています（ノートブックのデフォルト）...&quot;</span><span class="p">)</span>
</span><span id="__span-19-64"><a id="__codelineno-19-64" name="__codelineno-19-64" href="#__codelineno-19-64"></a>    <span class="k">await</span> <span class="n">run_stateful_conversation</span><span class="p">()</span>
</span><span id="__span-19-65"><a id="__codelineno-19-65" name="__codelineno-19-65" href="#__codelineno-19-65"></a>
</span><span id="__span-19-66"><a id="__codelineno-19-66" name="__codelineno-19-66" href="#__codelineno-19-66"></a>    <span class="c1"># 方法2：asyncio.run（標準のPythonスクリプト[.py]用）</span>
</span><span id="__span-19-67"><a id="__codelineno-19-67" name="__codelineno-19-67" href="#__codelineno-19-67"></a>    <span class="c1"># （...省略...）</span>
</span><span id="__span-19-68"><a id="__codelineno-19-68" name="__codelineno-19-68" href="#__codelineno-19-68"></a>
</span><span id="__span-19-69"><a id="__codelineno-19-69" name="__codelineno-19-69" href="#__codelineno-19-69"></a>    <span class="c1"># --- 会話後の最終セッション状態を検査 ---</span>
</span><span id="__span-19-70"><a id="__codelineno-19-70" name="__codelineno-19-70" href="#__codelineno-19-70"></a>    <span class="c1"># このブロックは、いずれかの実行方法が完了した後に実行されます。</span>
</span><span id="__span-19-71"><a id="__codelineno-19-71" name="__codelineno-19-71" href="#__codelineno-19-71"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- 最終セッション状態の検査 ---&quot;</span><span class="p">)</span>
</span><span id="__span-19-72"><a id="__codelineno-19-72" name="__codelineno-19-72" href="#__codelineno-19-72"></a>    <span class="n">final_session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-19-73"><a id="__codelineno-19-73" name="__codelineno-19-73" href="#__codelineno-19-73"></a>                                                         <span class="n">user_id</span><span class="o">=</span> <span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-19-74"><a id="__codelineno-19-74" name="__codelineno-19-74" href="#__codelineno-19-74"></a>                                                         <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
</span><span id="__span-19-75"><a id="__codelineno-19-75" name="__codelineno-19-75" href="#__codelineno-19-75"></a>    <span class="k">if</span> <span class="n">final_session</span><span class="p">:</span>
</span><span id="__span-19-76"><a id="__codelineno-19-76" name="__codelineno-19-76" href="#__codelineno-19-76"></a>        <span class="c1"># 存在しない可能性のあるキーに安全にアクセスするために.get()を使用</span>
</span><span id="__span-19-77"><a id="__codelineno-19-77" name="__codelineno-19-77" href="#__codelineno-19-77"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;最終的な設定：</span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;設定されていません&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-19-78"><a id="__codelineno-19-78" name="__codelineno-19-78" href="#__codelineno-19-78"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;最後の天気予報（output_keyから）：</span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_weather_report&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;設定されていません&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-19-79"><a id="__codelineno-19-79" name="__codelineno-19-79" href="#__codelineno-19-79"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;最後に確認された都市（ツールによる）：</span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_city_checked_stateful&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;設定されていません&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-19-80"><a id="__codelineno-19-80" name="__codelineno-19-80" href="#__codelineno-19-80"></a>        <span class="c1"># 詳細表示のために完全な状態を出力</span>
</span><span id="__span-19-81"><a id="__codelineno-19-81" name="__codelineno-19-81" href="#__codelineno-19-81"></a>        <span class="c1"># print(f&quot;完全な状態辞書：{final_session.state}&quot;)</span>
</span><span id="__span-19-82"><a id="__codelineno-19-82" name="__codelineno-19-82" href="#__codelineno-19-82"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-19-83"><a id="__codelineno-19-83" name="__codelineno-19-83" href="#__codelineno-19-83"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">❌ エラー：最終セッション状態を取得できませんでした。&quot;</span><span class="p">)</span>
</span><span id="__span-19-84"><a id="__codelineno-19-84" name="__codelineno-19-84" href="#__codelineno-19-84"></a>
</span><span id="__span-19-85"><a id="__codelineno-19-85" name="__codelineno-19-85" href="#__codelineno-19-85"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-19-86"><a id="__codelineno-19-86" name="__codelineno-19-86" href="#__codelineno-19-86"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ 状態テストの会話をスキップします。状態対応ルートエージェントのランナー（&#39;runner_root_stateful&#39;）が利用できません。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p>会話の流れと最終的なセッション状態の出力を見直すことで、以下を確認できます：</p>
<ul>
<li><strong>状態の読み取り：</strong> 天気ツール（<code>get_weather_stateful</code>）は、状態から<code>user_preference_temperature_unit</code>を正しく読み取り、最初はロンドンのために「摂氏」を使用しました。</li>
<li><strong>状態の更新：</strong> 直接の変更により、保存されていた設定が「華氏」に正常に変更されました。</li>
<li><strong>状態の読み取り（更新後）：</strong> ツールはその後、ニューヨークの天気を尋ねられた際に「華氏」を読み取り、変換を実行しました。</li>
<li><strong>ツールの状態書き込み：</strong> ツールは、<code>tool_context.state</code>を介して<code>last_city_checked_stateful</code>（2回目の天気確認後の「New York」）を状態に正常に書き込みました。</li>
<li><strong>委任：</strong> 「こんにちは！」に対する<code>greeting_agent</code>への委任は、状態変更後も正しく機能しました。</li>
<li><strong><code>output_key</code>：</strong> <code>output_key="last_weather_report"</code>は、ルートエージェントが最終的に応答した<em>各ターン</em>のルートエージェントの<em>最終</em>応答を正常に保存しました。このシーケンスでは、最後の応答は挨拶（「こんにちは！」）だったため、それが状態キーの天気予報を上書きしました。</li>
<li><strong>最終状態：</strong> 最終確認で、設定が「華氏」として永続化されていることが確認されます。</li>
</ul>
<p>これで、<code>ToolContext</code>を使用してエージェントの振る舞いをパーソナライズするためのセッション状態の統合、<code>InMemorySessionService</code>のテストのための状態の手動操作、そして<code>output_key</code>がエージェントの最後の応答を状態に保存するための簡単なメカニズムを提供する方法を正常に確認しました。この状態管理の基本的な理解は、次のステップでコールバックを使用して安全ガードレールを実装する上で重要です。</p>
<hr />
<h2 id="5-before_model_callback">ステップ5：安全性の追加 - <code>before_model_callback</code>による入力ガードレール<a class="headerlink" href="#5-before_model_callback" title="Permanent link">&para;</a></h2>
<p>私たちのエージェントチームは、設定を記憶し、ツールを効果的に使用することで、ますます有能になっています。しかし、実世界のシナリオでは、潜在的に問題のあるリクエストが中核となる大規模言語モデル（LLM）に到達する<em>前</em>に、エージェントの振る舞いを制御するための安全メカニズムがしばしば必要になります。</p>
<p>ADKは<strong>コールバック</strong>を提供します。これは、エージェントの実行ライフサイクルの特定のポイントにフックできる関数です。<code>before_model_callback</code>は、入力の安全性に特に役立ちます。</p>
<p><strong><code>before_model_callback</code>とは？</strong></p>
<ul>
<li>エージェントがコンパイルされたリクエスト（会話履歴、指示、最新のユーザーメッセージを含む）を基盤となるLLMに送信する<em>直前</em>にADKが実行する、あなたが定義するPython関数です。</li>
<li><strong>目的：</strong> リクエストを検査し、必要に応じて変更するか、事前定義されたルールに基づいて完全にブロックします。</li>
</ul>
<p><strong>一般的なユースケース：</strong></p>
<ul>
<li><strong>入力の検証/フィルタリング：</strong> ユーザー入力が基準を満たしているか、許可されていないコンテンツ（PIIやキーワードなど）を含んでいないかを確認します。</li>
<li><strong>ガードレール：</strong> 有害、トピック外、またはポリシーに違反するリクエストがLLMによって処理されるのを防ぎます。</li>
<li><strong>動的なプロンプトの変更：</strong> 送信する直前に、タイムリーな情報（例：セッション状態から）をLLMリクエストのコンテキストに追加します。</li>
</ul>
<p><strong>仕組み：</strong></p>
<ol>
<li>
<p><code>callback_context: CallbackContext</code>と<code>llm_request: LlmRequest</code>を受け入れる関数を定義します。</p>
<ul>
<li><code>callback_context</code>: エージェント情報、セッション状態（<code>callback_context.state</code>）などへのアクセスを提供します。</li>
<li><code>llm_request</code>: LLMに送られる予定の完全なペイロード（<code>contents</code>、<code>config</code>）を含みます。</li>
</ul>
</li>
<li>
<p>関数内で：</p>
<ul>
<li><strong>検査：</strong> <code>llm_request.contents</code>（特に最後のユーザーメッセージ）を調べます。</li>
<li><strong>変更（注意して使用）：</strong> <code>llm_request</code>の一部を変更<em>できます</em>。</li>
<li><strong>ブロック（ガードレール）：</strong> <code>LlmResponse</code>オブジェクトを返します。ADKはこの応答をすぐに返し、そのターンのLLM呼び出しを<em>スキップ</em>します。</li>
<li><strong>許可：</strong> <code>None</code>を返します。ADKは（潜在的に変更された）リクエストでLLMを呼び出します。</li>
</ul>
</li>
</ol>
<p><strong>このステップでは、以下のことを行います：</strong></p>
<ol>
<li>ユーザーの入力に特定のキーワード（"BLOCK"）があるかチェックする<code>before_model_callback</code>関数（<code>block_keyword_guardrail</code>）を定義します。</li>
<li>状態対応のルートエージェント（ステップ4の<code>weather_agent_v4_stateful</code>）を更新して、このコールバックを使用するようにします。</li>
<li>この更新されたエージェントに関連付けられた新しいランナーを作成しますが、状態の継続性を維持するために<em>同じ状態対応セッションサービス</em>を使用します。</li>
<li>通常のリクエストとキーワードを含むリクエストの両方を送信して、ガードレールをテストします。</li>
</ol>
<hr />
<p><strong>1. ガードレールコールバック関数の定義</strong></p>
<p>この関数は、<code>llm_request</code>のコンテンツ内の最後のユーザーメッセージを検査します。もし"BLOCK"（大文字と小文字を区別しない）が見つかった場合、<code>LlmResponse</code>を構築して返し、フローをブロックします。それ以外の場合は<code>None</code>を返します。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="c1"># @title 1. before_model_callbackガードレールの定義</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="c1"># 必要なインポートが利用可能であることを確認</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.agents.callback_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">CallbackContext</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.llm_request</span><span class="w"> </span><span class="kn">import</span> <span class="n">LlmRequest</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.models.llm_response</span><span class="w"> </span><span class="kn">import</span> <span class="n">LlmResponse</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.genai</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span> <span class="c1"># 応答コンテンツ作成用</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="k">def</span><span class="w"> </span><span class="nf">block_keyword_guardrail</span><span class="p">(</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>    <span class="n">callback_context</span><span class="p">:</span> <span class="n">CallbackContext</span><span class="p">,</span> <span class="n">llm_request</span><span class="p">:</span> <span class="n">LlmRequest</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LlmResponse</span><span class="p">]:</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="sd">    最新のユーザーメッセージに&#39;BLOCK&#39;が含まれているか検査します。見つかった場合、LLM呼び出しをブロックし、</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="sd">    事前定義されたLlmResponseを返します。それ以外の場合は、Noneを返して続行します。</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>    <span class="n">agent_name</span> <span class="o">=</span> <span class="n">callback_context</span><span class="o">.</span><span class="n">agent_name</span> <span class="c1"># モデル呼び出しが傍受されているエージェントの名前を取得</span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- コールバック：block_keyword_guardrailがエージェント：</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">で実行中 ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>    <span class="c1"># リクエスト履歴の最新のユーザーメッセージからテキストを抽出</span>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>    <span class="n">last_user_message_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>    <span class="k">if</span> <span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span><span class="p">:</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>        <span class="c1"># &#39;user&#39;ロールを持つ最新のメッセージを検索</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>        <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">llm_request</span><span class="o">.</span><span class="n">contents</span><span class="p">):</span>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>            <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;user&#39;</span> <span class="ow">and</span> <span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="p">:</span>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>                <span class="c1"># 簡単のため、テキストは最初のパートにあると仮定</span>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>                <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>                    <span class="n">last_user_message_text</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">parts</span><span class="o">.</span><span class="n">text</span>
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>                    <span class="k">break</span> <span class="c1"># 最新のユーザーメッセージテキストを見つけた</span>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a>
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- コールバック：最新のユーザーメッセージを検査中：&#39;</span><span class="si">{</span><span class="n">last_user_message_text</span><span class="p">[:</span><span class="mi">100</span><span class="p">]</span><span class="si">}</span><span class="s2">...&#39; ---&quot;</span><span class="p">)</span> <span class="c1"># 最初の100文字をログに記録</span>
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a>
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a>    <span class="c1"># --- ガードレールロジック ---</span>
</span><span id="__span-20-34"><a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>    <span class="n">keyword_to_block</span> <span class="o">=</span> <span class="s2">&quot;BLOCK&quot;</span>
</span><span id="__span-20-35"><a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a>    <span class="k">if</span> <span class="n">keyword_to_block</span> <span class="ow">in</span> <span class="n">last_user_message_text</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span> <span class="c1"># 大文字小文字を区別しないチェック</span>
</span><span id="__span-20-36"><a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- コールバック：&#39;</span><span class="si">{</span><span class="n">keyword_to_block</span><span class="si">}</span><span class="s2">&#39;を発見。LLM呼び出しをブロックします！ ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-37"><a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a>        <span class="c1"># オプション：ブロックイベントを記録するために状態にフラグを設定</span>
</span><span id="__span-20-38"><a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a>        <span class="n">callback_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;guardrail_block_keyword_triggered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-20-39"><a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- コールバック：状態&#39;guardrail_block_keyword_triggered&#39;をTrueに設定しました ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-40"><a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a>
</span><span id="__span-20-41"><a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a>        <span class="c1"># フローを停止し、代わりにこれを返すLlmResponseを構築して返す</span>
</span><span id="__span-20-42"><a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a>        <span class="k">return</span> <span class="n">LlmResponse</span><span class="p">(</span>
</span><span id="__span-20-43"><a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a>            <span class="n">content</span><span class="o">=</span><span class="n">types</span><span class="o">.</span><span class="n">Content</span><span class="p">(</span>
</span><span id="__span-20-44"><a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a>                <span class="n">role</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="c1"># エージェントの視点からの応答を模倣</span>
</span><span id="__span-20-45"><a id="__codelineno-20-45" name="__codelineno-20-45" href="#__codelineno-20-45"></a>                <span class="n">parts</span><span class="o">=</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">Part</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ブロックされたキーワード&#39;</span><span class="si">{</span><span class="n">keyword_to_block</span><span class="si">}</span><span class="s2">&#39;が含まれているため、このリクエストは処理できません。&quot;</span><span class="p">)],</span>
</span><span id="__span-20-46"><a id="__codelineno-20-46" name="__codelineno-20-46" href="#__codelineno-20-46"></a>            <span class="p">)</span>
</span><span id="__span-20-47"><a id="__codelineno-20-47" name="__codelineno-20-47" href="#__codelineno-20-47"></a>            <span class="c1"># 注意：必要に応じて、ここにerror_messageフィールドを設定することもできます</span>
</span><span id="__span-20-48"><a id="__codelineno-20-48" name="__codelineno-20-48" href="#__codelineno-20-48"></a>        <span class="p">)</span>
</span><span id="__span-20-49"><a id="__codelineno-20-49" name="__codelineno-20-49" href="#__codelineno-20-49"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-20-50"><a id="__codelineno-20-50" name="__codelineno-20-50" href="#__codelineno-20-50"></a>        <span class="c1"># キーワードが見つからなかったため、リクエストをLLMに進める</span>
</span><span id="__span-20-51"><a id="__codelineno-20-51" name="__codelineno-20-51" href="#__codelineno-20-51"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- コールバック：キーワードが見つかりませんでした。</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">のLLM呼び出しを許可します。 ---&quot;</span><span class="p">)</span>
</span><span id="__span-20-52"><a id="__codelineno-20-52" name="__codelineno-20-52" href="#__codelineno-20-52"></a>        <span class="k">return</span> <span class="kc">None</span> <span class="c1"># Noneを返すとADKは通常通り続行する</span>
</span><span id="__span-20-53"><a id="__codelineno-20-53" name="__codelineno-20-53" href="#__codelineno-20-53"></a>
</span><span id="__span-20-54"><a id="__codelineno-20-54" name="__codelineno-20-54" href="#__codelineno-20-54"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ block_keyword_guardrail関数が定義されました。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>2. コールバックを使用するようにルートエージェントを更新</strong></p>
<p>ルートエージェントを再定義し、<code>before_model_callback</code>パラメータを追加して、新しいガードレール関数を指すようにします。明確にするために新しいバージョン名を付けます。</p>
<p><em>重要：</em> ルートエージェントの定義がすべてのコンポーネントにアクセスできるように、このコンテキスト内でサブエージェント（<code>greeting_agent</code>、<code>farewell_agent</code>）と状態対応ツール（<code>get_weather_stateful</code>）を、以前のステップから利用可能でない場合は再定義する必要があります。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1"># @title 2. before_model_callbackでルートエージェントを更新</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="c1"># --- サブエージェントの再定義（このコンテキストに存在することを確認） ---</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="n">greeting_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>    <span class="c1"># 定義済みのモデル定数を使用</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a>    <span class="n">greeting_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a>        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;greeting_agent&quot;</span><span class="p">,</span> <span class="c1"># 一貫性のために元の名前を維持</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;あなたは挨拶エージェントです。あなたの唯一のタスクは&#39;say_hello&#39;ツールを使って親しみやすい挨拶を提供することです。他には何もしないでください。&quot;</span><span class="p">,</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&#39;say_hello&#39;ツールを使用して簡単な挨拶を処理します。&quot;</span><span class="p">,</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_hello</span><span class="p">],</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a>    <span class="p">)</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ サブエージェント&#39;</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;が再定義されました。&quot;</span><span class="p">)</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 挨拶エージェントを再定義できませんでした。モデル/APIキー(</span><span class="si">{</span><span class="n">greeting_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">)を確認してください。エラー：</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="n">farewell_agent</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="k">try</span><span class="p">:</span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a>    <span class="c1"># 定義済みのモデル定数を使用</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a>    <span class="n">farewell_agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a>        <span class="n">model</span><span class="o">=</span><span class="n">MODEL_GEMINI_2_0_FLASH</span><span class="p">,</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;farewell_agent&quot;</span><span class="p">,</span> <span class="c1"># 元の名前を維持</span>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;あなたは別れエージェントです。あなたの唯一のタスクは&#39;say_goodbye&#39;ツールを使って丁寧なさようならのメッセージを提供することです。他のアクションは実行しないでください。&quot;</span><span class="p">,</span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&#39;say_goodbye&#39;ツールを使用して簡単な別れを処理します。&quot;</span><span class="p">,</span>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">say_goodbye</span><span class="p">],</span>
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a>    <span class="p">)</span>
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ サブエージェント&#39;</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;が再定義されました。&quot;</span><span class="p">)</span>
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a><span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;❌ 別れエージェントを再定義できませんでした。モデル/APIキー(</span><span class="si">{</span><span class="n">farewell_agent</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">)を確認してください。エラー：</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-21-31"><a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a>
</span><span id="__span-21-32"><a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a>
</span><span id="__span-21-33"><a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a><span class="c1"># --- コールバックを持つルートエージェントの定義 ---</span>
</span><span id="__span-21-34"><a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a><span class="n">root_agent_model_guardrail</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-21-35"><a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a><span class="n">runner_root_model_guardrail</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-21-36"><a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a>
</span><span id="__span-21-37"><a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a><span class="c1"># 続行する前にすべてのコンポーネントを確認</span>
</span><span id="__span-21-38"><a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a><span class="k">if</span> <span class="n">greeting_agent</span> <span class="ow">and</span> <span class="n">farewell_agent</span> <span class="ow">and</span> <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;block_keyword_guardrail&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-21-39"><a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a>
</span><span id="__span-21-40"><a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a>    <span class="c1"># 定義済みのモデル定数を使用</span>
</span><span id="__span-21-41"><a id="__codelineno-21-41" name="__codelineno-21-41" href="#__codelineno-21-41"></a>    <span class="n">root_agent_model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span>
</span><span id="__span-21-42"><a id="__codelineno-21-42" name="__codelineno-21-42" href="#__codelineno-21-42"></a>
</span><span id="__span-21-43"><a id="__codelineno-21-43" name="__codelineno-21-43" href="#__codelineno-21-43"></a>    <span class="n">root_agent_model_guardrail</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-21-44"><a id="__codelineno-21-44" name="__codelineno-21-44" href="#__codelineno-21-44"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v5_model_guardrail&quot;</span><span class="p">,</span> <span class="c1"># 明確にするための新しいバージョン名</span>
</span><span id="__span-21-45"><a id="__codelineno-21-45" name="__codelineno-21-45" href="#__codelineno-21-45"></a>        <span class="n">model</span><span class="o">=</span><span class="n">root_agent_model</span><span class="p">,</span>
</span><span id="__span-21-46"><a id="__codelineno-21-46" name="__codelineno-21-46" href="#__codelineno-21-46"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;メインエージェント：天気を処理し、挨拶/別れを委任し、入力キーワードガードレールを含みます。&quot;</span><span class="p">,</span>
</span><span id="__span-21-47"><a id="__codelineno-21-47" name="__codelineno-21-47" href="#__codelineno-21-47"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;あなたはメインの天気エージェントです。&#39;get_weather_stateful&#39;を使って天気を提供してください。&quot;</span>
</span><span id="__span-21-48"><a id="__codelineno-21-48" name="__codelineno-21-48" href="#__codelineno-21-48"></a>                    <span class="s2">&quot;簡単な挨拶は&#39;greeting_agent&#39;に、別れは&#39;farewell_agent&#39;に委任してください。&quot;</span>
</span><span id="__span-21-49"><a id="__codelineno-21-49" name="__codelineno-21-49" href="#__codelineno-21-49"></a>                    <span class="s2">&quot;天気のリクエスト、挨拶、別れのみを処理してください。&quot;</span><span class="p">,</span>
</span><span id="__span-21-50"><a id="__codelineno-21-50" name="__codelineno-21-50" href="#__codelineno-21-50"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather</span><span class="p">],</span>
</span><span id="__span-21-51"><a id="__codelineno-21-51" name="__codelineno-21-51" href="#__codelineno-21-51"></a>        <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">greeting_agent</span><span class="p">,</span> <span class="n">farewell_agent</span><span class="p">],</span> <span class="c1"># 再定義されたサブエージェントを参照</span>
</span><span id="__span-21-52"><a id="__codelineno-21-52" name="__codelineno-21-52" href="#__codelineno-21-52"></a>        <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;last_weather_report&quot;</span><span class="p">,</span> <span class="c1"># ステップ4のoutput_keyを維持</span>
</span><span id="__span-21-53"><a id="__codelineno-21-53" name="__codelineno-21-53" href="#__codelineno-21-53"></a>        <span class="n">before_model_callback</span><span class="o">=</span><span class="n">block_keyword_guardrail</span> <span class="c1"># &lt;&lt;&lt; ガードレールコールバックを割り当てる</span>
</span><span id="__span-21-54"><a id="__codelineno-21-54" name="__codelineno-21-54" href="#__codelineno-21-54"></a>    <span class="p">)</span>
</span><span id="__span-21-55"><a id="__codelineno-21-55" name="__codelineno-21-55" href="#__codelineno-21-55"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ ルートエージェント&#39;</span><span class="si">{</span><span class="n">root_agent_model_guardrail</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;がbefore_model_callbackで作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-21-56"><a id="__codelineno-21-56" name="__codelineno-21-56" href="#__codelineno-21-56"></a>
</span><span id="__span-21-57"><a id="__codelineno-21-57" name="__codelineno-21-57" href="#__codelineno-21-57"></a>    <span class="c1"># --- このエージェントのためのRunnerを作成、同じ状態対応セッションサービスを使用 ---</span>
</span><span id="__span-21-58"><a id="__codelineno-21-58" name="__codelineno-21-58" href="#__codelineno-21-58"></a>    <span class="c1"># session_service_statefulがステップ4から存在することを確認</span>
</span><span id="__span-21-59"><a id="__codelineno-21-59" name="__codelineno-21-59" href="#__codelineno-21-59"></a>    <span class="k">if</span> <span class="s1">&#39;session_service_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-21-60"><a id="__codelineno-21-60" name="__codelineno-21-60" href="#__codelineno-21-60"></a>        <span class="n">runner_root_model_guardrail</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-21-61"><a id="__codelineno-21-61" name="__codelineno-21-61" href="#__codelineno-21-61"></a>            <span class="n">agent</span><span class="o">=</span><span class="n">root_agent_model_guardrail</span><span class="p">,</span>
</span><span id="__span-21-62"><a id="__codelineno-21-62" name="__codelineno-21-62" href="#__codelineno-21-62"></a>            <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span> <span class="c1"># 一貫したAPP_NAMEを使用</span>
</span><span id="__span-21-63"><a id="__codelineno-21-63" name="__codelineno-21-63" href="#__codelineno-21-63"></a>            <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_stateful</span> <span class="c1"># &lt;&lt;&lt; ステップ4のサービスを使用</span>
</span><span id="__span-21-64"><a id="__codelineno-21-64" name="__codelineno-21-64" href="#__codelineno-21-64"></a>        <span class="p">)</span>
</span><span id="__span-21-65"><a id="__codelineno-21-65" name="__codelineno-21-65" href="#__codelineno-21-65"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ ガードレールエージェント&#39;</span><span class="si">{</span><span class="n">runner_root_model_guardrail</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;用のRunnerが、状態対応セッションサービスを使用して作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-21-66"><a id="__codelineno-21-66" name="__codelineno-21-66" href="#__codelineno-21-66"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-21-67"><a id="__codelineno-21-67" name="__codelineno-21-67" href="#__codelineno-21-67"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ runnerを作成できません。ステップ4の&#39;session_service_stateful&#39;が見つかりません。&quot;</span><span class="p">)</span>
</span><span id="__span-21-68"><a id="__codelineno-21-68" name="__codelineno-21-68" href="#__codelineno-21-68"></a>
</span><span id="__span-21-69"><a id="__codelineno-21-69" name="__codelineno-21-69" href="#__codelineno-21-69"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-21-70"><a id="__codelineno-21-70" name="__codelineno-21-70" href="#__codelineno-21-70"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ モデルガードレールを持つルートエージェントを作成できません。1つ以上の前提条件が見つからないか、初期化に失敗しました：&quot;</span><span class="p">)</span>
</span><span id="__span-21-71"><a id="__codelineno-21-71" name="__codelineno-21-71" href="#__codelineno-21-71"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">greeting_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - 挨拶エージェント&quot;</span><span class="p">)</span>
</span><span id="__span-21-72"><a id="__codelineno-21-72" name="__codelineno-21-72" href="#__codelineno-21-72"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">farewell_agent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - 別れエージェント&quot;</span><span class="p">)</span>
</span><span id="__span-21-73"><a id="__codelineno-21-73" name="__codelineno-21-73" href="#__codelineno-21-73"></a>    <span class="k">if</span> <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - &#39;get_weather_stateful&#39; ツール&quot;</span><span class="p">)</span>
</span><span id="__span-21-74"><a id="__codelineno-21-74" name="__codelineno-21-74" href="#__codelineno-21-74"></a>    <span class="k">if</span> <span class="s1">&#39;block_keyword_guardrail&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   - &#39;block_keyword_guardrail&#39; コールバック&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>3. 対話してガードレールをテストする</strong></p>
<p>ガードレールの振る舞いをテストしましょう。ステップ4と同じセッション（<code>SESSION_ID_STATEFUL</code>）を使用して、これらの変更をまたいで状態が永続することを示します。</p>
<ol>
<li>通常の天気のリクエストを送信します（ガードレールを通過して実行されるはずです）。</li>
<li>"BLOCK"を含むリクエストを送信します（コールバックによって傍受されるはずです）。</li>
<li>挨拶を送信します（ルートエージェントのガードレールを通過し、委任されて正常に実行されるはずです）。</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="c1"># @title 3. 対話してモデル入力ガードレールをテストする</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span> <span class="c1"># asyncioがインポートされていることを確認</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="c1"># ガードレールエージェント用のランナーが利用可能であることを確認</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="k">if</span> <span class="s1">&#39;runner_root_model_guardrail&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">runner_root_model_guardrail</span><span class="p">:</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>    <span class="c1"># ガードレールテスト会話のためのメインのasync関数を定義します。</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>    <span class="c1"># この関数内の&#39;await&#39;キーワードは非同期操作に必要です。</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_guardrail_test_conversation</span><span class="p">():</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- モデル入力ガードレールのテスト中 ---&quot;</span><span class="p">)</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>        <span class="c1"># コールバックを持つエージェント用のランナーと、既存の状態対応セッションIDを使用</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>        <span class="c1"># よりクリーンなインタラクション呼び出しのためのヘルパーラムダを定義</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>        <span class="n">interaction_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">query</span><span class="p">:</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="p">,</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>                                                         <span class="n">runner_root_model_guardrail</span><span class="p">,</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>                                                         <span class="n">USER_ID_STATEFUL</span><span class="p">,</span> <span class="c1"># 既存のユーザーIDを使用</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>                                                         <span class="n">SESSION_ID_STATEFUL</span> <span class="c1"># 既存のセッションIDを使用</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>                                                        <span class="p">)</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>        <span class="c1"># 1. 通常のリクエスト（コールバックは許可し、以前の状態変更から華氏を使用するはず）</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- ターン1：ロンドンの天気をリクエスト（許可され、華氏を期待） ---&quot;</span><span class="p">)</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;ロンドンの天気は？&quot;</span><span class="p">)</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>        <span class="c1"># 2. ブロックされたキーワードを含むリクエスト（コールバックが傍受）</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- ターン2：ブロックされたキーワードでリクエスト（ブロックされることを期待） ---&quot;</span><span class="p">)</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;東京の天気をリクエストするのをBLOCKして&quot;</span><span class="p">)</span> <span class="c1"># コールバックが &quot;BLOCK&quot; をキャッチするはず</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>        <span class="c1"># 3. 通常の挨拶（コールバックはルートエージェントを許可し、委任が発生）</span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- ターン3：挨拶を送信（許可されることを期待） ---&quot;</span><span class="p">)</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;またこんにちは&quot;</span><span class="p">)</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>    <span class="c1"># --- `run_guardrail_test_conversation` async関数を実行 ---</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>    <span class="c1"># （...省略...）</span>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&#39;await&#39;を使用した実行を試みています（ノートブックのデフォルト）...&quot;</span><span class="p">)</span>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a>    <span class="k">await</span> <span class="n">run_guardrail_test_conversation</span><span class="p">()</span>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>
</span><span id="__span-22-35"><a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>    <span class="c1"># --- 会話後の最終セッション状態を検査 ---</span>
</span><span id="__span-22-36"><a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a>    <span class="c1"># オプション：コールバックによって設定されたトリガーフラグの状態を確認</span>
</span><span id="__span-22-37"><a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- 最終セッション状態の検査（ガードレールテスト後） ---&quot;</span><span class="p">)</span>
</span><span id="__span-22-38"><a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a>    <span class="c1"># この状態対応セッションに関連付けられたセッションサービスインスタンスを使用</span>
</span><span id="__span-22-39"><a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a>    <span class="n">final_session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-22-40"><a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a>                                                         <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-22-41"><a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a>                                                         <span class="n">session_id</span><span class="o">=</span><span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
</span><span id="__span-22-42"><a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a>    <span class="k">if</span> <span class="n">final_session</span><span class="p">:</span>
</span><span id="__span-22-43"><a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a>        <span class="c1"># 安全なアクセスのために.get()を使用</span>
</span><span id="__span-22-44"><a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ガードレールトリガーフラグ：</span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;guardrail_block_keyword_triggered&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;設定されていない（またはFalse）&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-22-45"><a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;最後の天気予報：</span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_weather_report&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;設定されていない&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># 成功すればロンドンの天気のはず</span>
</span><span id="__span-22-46"><a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;温度単位：</span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;設定されていない&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># 華氏のはず</span>
</span><span id="__span-22-47"><a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-22-48"><a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">❌ エラー：最終セッション状態を取得できませんでした。&quot;</span><span class="p">)</span>
</span><span id="__span-22-49"><a id="__codelineno-22-49" name="__codelineno-22-49" href="#__codelineno-22-49"></a>
</span><span id="__span-22-50"><a id="__codelineno-22-50" name="__codelineno-22-50" href="#__codelineno-22-50"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-22-51"><a id="__codelineno-22-51" name="__codelineno-22-51" href="#__codelineno-22-51"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ モデルガードレールのテストをスキップします。ランナー（&#39;runner_root_model_guardrail&#39;）が利用できません。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p>実行フローを観察してください：</p>
<ol>
<li><strong>ロンドンの天気：</strong> コールバックが<code>weather_agent_v5_model_guardrail</code>に対して実行され、メッセージを検査し、「キーワードが見つかりません。LLM呼び出しを許可します。」と出力して<code>None</code>を返します。エージェントは続行し、<code>get_weather_stateful</code>ツールを呼び出し（ステップ4の状態変更から「華氏」設定を使用）、天気を返します。この応答は<code>output_key</code>を介して<code>last_weather_report</code>を更新します。</li>
<li><strong>BLOCKリクエスト：</strong> コールバックが<code>weather_agent_v5_model_guardrail</code>に対して再度実行され、メッセージを検査し、「BLOCK」を見つけ、「LLM呼び出しをブロックします！」と出力し、状態フラグを設定し、事前定義された<code>LlmResponse</code>を返します。このターンではエージェントの基盤となるLLMは<em>決して呼び出されません</em>。ユーザーはコールバックのブロッキングメッセージを見ます。</li>
<li><strong>またこんにちは：</strong> コールバックが<code>weather_agent_v5_model_guardrail</code>に対して実行され、リクエストを許可します。その後、ルートエージェントは<code>greeting_agent</code>に委任します。<em>注意：ルートエージェントで定義された<code>before_model_callback</code>は、サブエージェントに自動的には適用されません。</em><code>greeting_agent</code>は通常通り続行し、<code>say_hello</code>ツールを呼び出して挨拶を返します。</li>
</ol>
<p>これで、入力安全層を正常に実装しました！<code>before_model_callback</code>は、高価なまたは潜在的に危険なLLM呼び出しが行われる<em>前</em>に、ルールを強制し、エージェントの振る舞いを制御するための強力なメカニズムを提供します。次に、ツール自体の使用に関するガードレールを追加するために、同様の概念を適用します。</p>
<h2 id="6-before_tool_callback">ステップ6：安全性の追加 - ツール引数ガードレール (<code>before_tool_callback</code>)<a class="headerlink" href="#6-before_tool_callback" title="Permanent link">&para;</a></h2>
<p>ステップ5では、ユーザー入力がLLMに到達する<em>前</em>にそれを検査し、潜在的にブロックするガードレールを追加しました。次に、LLMがツールの使用を決定した後、しかしそのツールが実際に実行される<em>前</em>に、別の制御層を追加します。これは、LLMがツールに渡そうとする<em>引数</em>を検証するのに役立ちます。</p>
<p>ADKはこの正確な目的のために<code>before_tool_callback</code>を提供します。</p>
<p><strong><code>before_tool_callback</code>とは？</strong></p>
<ul>
<li>LLMがその使用を要求し、引数を決定した後、特定のツール関数が実行される<em>直前</em>に実行されるPython関数です。</li>
<li><strong>目的：</strong> ツール引数の検証、特定の入力に基づくツール実行の防止、引数の動的な変更、またはリソース使用ポリシーの強制。</li>
</ul>
<p><strong>一般的なユースケース：</strong></p>
<ul>
<li><strong>引数の検証：</strong> LLMによって提供された引数が有効であるか、許容範囲内であるか、または期待される形式に準拠しているかを確認します。</li>
<li><strong>リソース保護：</strong> コストがかかる、制限されたデータにアクセスする、または望ましくない副作用を引き起こす可能性のある入力でツールが呼び出されるのを防ぎます（例：特定のパラメータに対するAPI呼び出しのブロック）。</li>
<li><strong>動的な引数の変更：</strong> ツールが実行される前に、セッション状態や他のコンテキスト情報に基づいて引数を調整します。</li>
</ul>
<p><strong>仕組み：</strong></p>
<ol>
<li>
<p><code>tool: BaseTool</code>、<code>args: Dict[str, Any]</code>、および<code>tool_context: ToolContext</code>を受け入れる関数を定義します。</p>
<ul>
<li><code>tool</code>: 呼び出されようとしているツールオブジェクト（<code>tool.name</code>を検査）。</li>
<li><code>args</code>: LLMがツール用に生成した引数の辞書。</li>
<li><code>tool_context</code>: セッション状態（<code>tool_context.state</code>）、エージェント情報などへのアクセスを提供します。</li>
</ul>
</li>
<li>
<p>関数内で：</p>
<ul>
<li><strong>検査：</strong> <code>tool.name</code>と<code>args</code>辞書を調べます。</li>
<li><strong>変更：</strong> <code>args</code>辞書内の値を<em>直接</em>変更します。<code>None</code>を返すと、ツールはこれらの変更された引数で実行されます。</li>
<li><strong>ブロック/上書き（ガードレール）：</strong> <strong>辞書</strong>を返します。ADKはこの辞書をツール呼び出しの<em>結果</em>として扱い、元のツール関数の実行を完全に<em>スキップ</em>します。辞書は、ブロックしているツールの期待される戻り形式と一致することが理想的です。</li>
<li><strong>許可：</strong> <code>None</code>を返します。ADKは実際のツール関数を（潜在的に変更された）引数で実行します。</li>
</ul>
</li>
</ol>
<p><strong>このステップでは、以下のことを行います：</strong></p>
<ol>
<li><code>get_weather_stateful</code>ツールが都市「Paris」で呼び出されたかどうかを具体的にチェックする<code>before_tool_callback</code>関数（<code>block_paris_tool_guardrail</code>）を定義します。</li>
<li>「Paris」が検出された場合、コールバックはツールをブロックし、カスタムエラー辞書を返します。</li>
<li><code>before_model_callback</code>とこの新しい<code>before_tool_callback</code>の両方を含むようにルートエージェント（<code>weather_agent_v6_tool_guardrail</code>）を更新します。</li>
<li>このエージェント用の新しいランナーを作成し、同じ状態対応セッションサービスを使用します。</li>
<li>許可された都市とブロックされた都市（「Paris」）の天気をリクエストして、フローをテストします。</li>
</ol>
<hr />
<p><strong>1. ツールガードレールコールバック関数の定義</strong></p>
<p>この関数は<code>get_weather_stateful</code>ツールを対象とします。<code>city</code>引数をチェックし、それが「Paris」であれば、ツール自体のエラー応答のように見えるエラー辞書を返します。それ以外の場合は、<code>None</code>を返してツールを実行させます。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="c1"># @title 1. before_tool_callbackガードレールの定義</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="c1"># 必要なインポートが利用可能であることを確認</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.tools.base_tool</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseTool</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">google.adk.tools.tool_context</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolContext</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span> <span class="c1"># 型ヒント用</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">block_paris_tool_guardrail</span><span class="p">(</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>    <span class="n">tool</span><span class="p">:</span> <span class="n">BaseTool</span><span class="p">,</span> <span class="n">args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">tool_context</span><span class="p">:</span> <span class="n">ToolContext</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="sd">    &#39;get_weather_stateful&#39;が&#39;Paris&#39;に対して呼び出されたかチェックします。</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a><span class="sd">    もしそうなら、ツール実行をブロックし、特定のエラー辞書を返します。</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="sd">    それ以外の場合は、Noneを返してツール呼び出しを続行させます。</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>    <span class="n">tool_name</span> <span class="o">=</span> <span class="n">tool</span><span class="o">.</span><span class="n">name</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>    <span class="n">agent_name</span> <span class="o">=</span> <span class="n">tool_context</span><span class="o">.</span><span class="n">agent_name</span> <span class="c1"># ツール呼び出しを試みているエージェント</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- コールバック：block_paris_tool_guardrailがエージェント&#39;</span><span class="si">{</span><span class="n">agent_name</span><span class="si">}</span><span class="s2">&#39;のツール&#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39;で実行中 ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- コールバック：引数を検査中：</span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>    <span class="c1"># --- ガードレールロジック ---</span>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>    <span class="n">target_tool_name</span> <span class="o">=</span> <span class="s2">&quot;get_weather_stateful&quot;</span> <span class="c1"># FunctionToolで使用される関数名と一致させる</span>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>    <span class="n">blocked_city</span> <span class="o">=</span> <span class="s2">&quot;paris&quot;</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>    <span class="c1"># 正しいツールであり、city引数がブロックされた都市と一致するかチェック</span>
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>    <span class="k">if</span> <span class="n">tool_name</span> <span class="o">==</span> <span class="n">target_tool_name</span><span class="p">:</span>
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>        <span class="n">city_argument</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;city&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1"># &#39;city&#39;引数を安全に取得</span>
</span><span id="__span-23-28"><a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>        <span class="k">if</span> <span class="n">city_argument</span> <span class="ow">and</span> <span class="n">city_argument</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">blocked_city</span><span class="p">:</span>
</span><span id="__span-23-29"><a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- コールバック：ブロックされた都市&#39;</span><span class="si">{</span><span class="n">city_argument</span><span class="si">}</span><span class="s2">&#39;を検出。ツール実行をブロックします！ ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-30"><a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>            <span class="c1"># オプションで状態を更新</span>
</span><span id="__span-23-31"><a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>            <span class="n">tool_context</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;guardrail_tool_block_triggered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="__span-23-32"><a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- コールバック：状態&#39;guardrail_tool_block_triggered&#39;をTrueに設定しました ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-33"><a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>
</span><span id="__span-23-34"><a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a>            <span class="c1"># エラーに関するツールの期待される出力形式に一致する辞書を返す</span>
</span><span id="__span-23-35"><a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>            <span class="c1"># この辞書がツールの結果となり、実際のツール実行はスキップされる</span>
</span><span id="__span-23-36"><a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a>            <span class="k">return</span> <span class="p">{</span>
</span><span id="__span-23-37"><a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a>                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span>
</span><span id="__span-23-38"><a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a>                <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;ポリシー制限：&#39;</span><span class="si">{</span><span class="n">city_argument</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;の天気チェックは現在、ツールガードレールによって無効化されています。&quot;</span>
</span><span id="__span-23-39"><a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>            <span class="p">}</span>
</span><span id="__span-23-40"><a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="__span-23-41"><a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a>             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- コールバック：都市&#39;</span><span class="si">{</span><span class="n">city_argument</span><span class="si">}</span><span class="s2">&#39;はツール&#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39;で許可されています。 ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-42"><a id="__codelineno-23-42" name="__codelineno-23-42" href="#__codelineno-23-42"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-23-43"><a id="__codelineno-23-43" name="__codelineno-23-43" href="#__codelineno-23-43"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- コールバック：ツール&#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39;は対象ツールではありません。許可します。 ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-44"><a id="__codelineno-23-44" name="__codelineno-23-44" href="#__codelineno-23-44"></a>
</span><span id="__span-23-45"><a id="__codelineno-23-45" name="__codelineno-23-45" href="#__codelineno-23-45"></a>    <span class="c1"># 上記のチェックが辞書を返さなかった場合、ツールの実行を許可</span>
</span><span id="__span-23-46"><a id="__codelineno-23-46" name="__codelineno-23-46" href="#__codelineno-23-46"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- コールバック：ツール&#39;</span><span class="si">{</span><span class="n">tool_name</span><span class="si">}</span><span class="s2">&#39;の実行を許可します。 ---&quot;</span><span class="p">)</span>
</span><span id="__span-23-47"><a id="__codelineno-23-47" name="__codelineno-23-47" href="#__codelineno-23-47"></a>    <span class="k">return</span> <span class="kc">None</span> <span class="c1"># Noneを返すと実際のツール関数が実行される</span>
</span><span id="__span-23-48"><a id="__codelineno-23-48" name="__codelineno-23-48" href="#__codelineno-23-48"></a>
</span><span id="__span-23-49"><a id="__codelineno-23-49" name="__codelineno-23-49" href="#__codelineno-23-49"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ block_paris_tool_guardrail関数が定義されました。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>2. 両方のコールバックを使用するようにルートエージェントを更新</strong></p>
<p>ルートエージェントを再度定義し（<code>weather_agent_v6_tool_guardrail</code>）、今回はステップ5の<code>before_model_callback</code>に加えて<code>before_tool_callback</code>パラメータを追加します。</p>
<p><em>自己完結型実行ノート：</em> ステップ5と同様に、このエージェントを定義する前に、すべての前提条件（サブエージェント、ツール、<code>before_model_callback</code>）が実行コンテキストで定義または利用可能であることを確認してください。</p>
<div class="language-python highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="c1"># @title 2. 両方のコールバックでルートエージェントを更新（自己完結型）</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="c1"># --- 前提条件が定義されていることを確認 ---</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="c1"># （Agent, LiteLlm, Runner, ToolContext, MODEL定数, say_hello, say_goodbye, </span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="c1">#  greeting_agent, farewell_agent, get_weather_stateful, </span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="c1">#  block_keyword_guardrail, block_paris_tool_guardrail の定義を含めるか実行を確認）</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="c1"># --- サブエージェントの再定義（このコンテキストに存在することを確認） ---</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="c1"># （...挨拶・別れエージェントの再定義コードは省略...）</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;✅ サブエージェントが再定義されました。&quot;</span><span class="p">)</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="c1"># --- 両方のコールバックを持つルートエージェントの定義 ---</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="n">root_agent_tool_guardrail</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="n">runner_root_tool_guardrail</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="k">if</span> <span class="p">(</span><span class="s1">&#39;greeting_agent&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">greeting_agent</span> <span class="ow">and</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>    <span class="s1">&#39;farewell_agent&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">farewell_agent</span> <span class="ow">and</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>    <span class="s1">&#39;get_weather_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span>
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>    <span class="s1">&#39;block_keyword_guardrail&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span>
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>    <span class="s1">&#39;block_paris_tool_guardrail&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()):</span>
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a>    <span class="n">root_agent_model</span> <span class="o">=</span> <span class="n">MODEL_GEMINI_2_0_FLASH</span>
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a>
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a>    <span class="n">root_agent_tool_guardrail</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">(</span>
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a>        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;weather_agent_v6_tool_guardrail&quot;</span><span class="p">,</span> <span class="c1"># 新しいバージョン名</span>
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a>        <span class="n">model</span><span class="o">=</span><span class="n">root_agent_model</span><span class="p">,</span>
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;メインエージェント：天気を処理し、委任し、入力およびツールガードレールを含みます。&quot;</span><span class="p">,</span>
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a>        <span class="n">instruction</span><span class="o">=</span><span class="s2">&quot;あなたはメインの天気エージェントです。&#39;get_weather_stateful&#39;を使って天気を提供してください。&quot;</span>
</span><span id="__span-24-29"><a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a>                    <span class="s2">&quot;挨拶は&#39;greeting_agent&#39;に、別れは&#39;farewell_agent&#39;に委任してください。&quot;</span>
</span><span id="__span-24-30"><a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a>                    <span class="s2">&quot;天気、挨拶、別れのみを処理してください。&quot;</span><span class="p">,</span>
</span><span id="__span-24-31"><a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a>        <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">get_weather_stateful</span><span class="p">],</span>
</span><span id="__span-24-32"><a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a>        <span class="n">sub_agents</span><span class="o">=</span><span class="p">[</span><span class="n">greeting_agent</span><span class="p">,</span> <span class="n">farewell_agent</span><span class="p">],</span>
</span><span id="__span-24-33"><a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a>        <span class="n">output_key</span><span class="o">=</span><span class="s2">&quot;last_weather_report&quot;</span><span class="p">,</span>
</span><span id="__span-24-34"><a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a>        <span class="n">before_model_callback</span><span class="o">=</span><span class="n">block_keyword_guardrail</span><span class="p">,</span> <span class="c1"># モデルガードレールを維持</span>
</span><span id="__span-24-35"><a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a>        <span class="n">before_tool_callback</span><span class="o">=</span><span class="n">block_paris_tool_guardrail</span> <span class="c1"># &lt;&lt;&lt; ツールガードレールを追加</span>
</span><span id="__span-24-36"><a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a>    <span class="p">)</span>
</span><span id="__span-24-37"><a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ ルートエージェント&#39;</span><span class="si">{</span><span class="n">root_agent_tool_guardrail</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;が両方のコールバックで作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-24-38"><a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a>
</span><span id="__span-24-39"><a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a>    <span class="c1"># --- Runnerを作成、同じ状態対応セッションサービスを使用 ---</span>
</span><span id="__span-24-40"><a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a>    <span class="k">if</span> <span class="s1">&#39;session_service_stateful&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">():</span>
</span><span id="__span-24-41"><a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a>        <span class="n">runner_root_tool_guardrail</span> <span class="o">=</span> <span class="n">Runner</span><span class="p">(</span>
</span><span id="__span-24-42"><a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a>            <span class="n">agent</span><span class="o">=</span><span class="n">root_agent_tool_guardrail</span><span class="p">,</span>
</span><span id="__span-24-43"><a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a>            <span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-24-44"><a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a>            <span class="n">session_service</span><span class="o">=</span><span class="n">session_service_stateful</span> <span class="c1"># &lt;&lt;&lt; ステップ4/5のサービスを使用</span>
</span><span id="__span-24-45"><a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a>        <span class="p">)</span>
</span><span id="__span-24-46"><a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ ツールガードレールエージェント&#39;</span><span class="si">{</span><span class="n">runner_root_tool_guardrail</span><span class="o">.</span><span class="n">agent</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;用のRunnerが、状態対応セッションサービスを使用して作成されました。&quot;</span><span class="p">)</span>
</span><span id="__span-24-47"><a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-24-48"><a id="__codelineno-24-48" name="__codelineno-24-48" href="#__codelineno-24-48"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ runnerを作成できません。ステップ4/5の&#39;session_service_stateful&#39;が見つかりません。&quot;</span><span class="p">)</span>
</span><span id="__span-24-49"><a id="__codelineno-24-49" name="__codelineno-24-49" href="#__codelineno-24-49"></a>
</span><span id="__span-24-50"><a id="__codelineno-24-50" name="__codelineno-24-50" href="#__codelineno-24-50"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-24-51"><a id="__codelineno-24-51" name="__codelineno-24-51" href="#__codelineno-24-51"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;❌ ツールガードレールを持つルートエージェントを作成できません。前提条件がありません。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p><strong>3. 対話してツールガードレールをテストする</strong></p>
<p>前のステップから同じ状態対応セッション（<code>SESSION_ID_STATEFUL</code>）を使用して、インタラクションフローをテストしましょう。</p>
<ol>
<li>「New York」の天気をリクエスト：両方のコールバックを通過し、ツールが実行されます（状態から華氏設定を使用）。</li>
<li>「Paris」の天気をリクエスト：<code>before_model_callback</code>を通過します。LLMは<code>get_weather_stateful(city='Paris')</code>を呼び出すことを決定します。<code>before_tool_callback</code>が傍受し、ツールをブロックし、エラー辞書を返します。エージェントはこのエラーを伝えます。</li>
<li>「London」の天気をリクエスト：両方のコールバックを通過し、ツールが正常に実行されます。</li>
</ol>
<div class="language-python highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c1"># @title 3. 対話してツール引数ガードレールをテストする</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span> <span class="c1"># asyncioがインポートされていることを確認</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="c1"># ツールガードレールエージェント用のランナーが利用可能であることを確認</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="k">if</span> <span class="s1">&#39;runner_root_tool_guardrail&#39;</span> <span class="ow">in</span> <span class="nb">globals</span><span class="p">()</span> <span class="ow">and</span> <span class="n">runner_root_tool_guardrail</span><span class="p">:</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>    <span class="c1"># ツールガードレールのテスト会話のためのメインのasync関数を定義します。</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>    <span class="c1"># この関数内の&#39;await&#39;キーワードは非同期操作に必要です。</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_tool_guardrail_test</span><span class="p">():</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- ツール引数ガードレールのテスト中（&#39;Paris&#39;がブロックされる） ---&quot;</span><span class="p">)</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a>        <span class="c1"># 両方のコールバックを持つエージェント用のランナーと、既存の状態対応セッションを使用</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a>        <span class="c1"># よりクリーンなインタラクション呼び出しのためのヘルパーラムダを定義</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a>        <span class="n">interaction_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">query</span><span class="p">:</span> <span class="n">call_agent_async</span><span class="p">(</span><span class="n">query</span><span class="p">,</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a>                                                         <span class="n">runner_root_tool_guardrail</span><span class="p">,</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a>                                                         <span class="n">USER_ID_STATEFUL</span><span class="p">,</span> <span class="c1"># 既存のユーザーIDを使用</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16" href="#__codelineno-25-16"></a>                                                         <span class="n">SESSION_ID_STATEFUL</span> <span class="c1"># 既存のセッションIDを使用</span>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17" href="#__codelineno-25-17"></a>                                                        <span class="p">)</span>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18" href="#__codelineno-25-18"></a>        <span class="c1"># 1. 許可された都市（両方のコールバックを通過し、華氏の状態を使用するはず）</span>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19" href="#__codelineno-25-19"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- ターン1：ニューヨークの天気をリクエスト（許可されることを期待） ---&quot;</span><span class="p">)</span>
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20" href="#__codelineno-25-20"></a>        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;ニューヨークの天気は？&quot;</span><span class="p">)</span>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21" href="#__codelineno-25-21"></a>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22" href="#__codelineno-25-22"></a>        <span class="c1"># 2. ブロックされた都市（モデルコールバックは通過するが、ツールコールバックでブロックされるはず）</span>
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23" href="#__codelineno-25-23"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- ターン2：パリの天気をリクエスト（ツールガードレールによってブロックされることを期待） ---&quot;</span><span class="p">)</span>
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24" href="#__codelineno-25-24"></a>        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;パリはどうですか？&quot;</span><span class="p">)</span> <span class="c1"># ツールコールバックがこれを傍受するはず</span>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25" href="#__codelineno-25-25"></a>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26" href="#__codelineno-25-26"></a>        <span class="c1"># 3. 別の許可された都市（再び正常に機能するはず）</span>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27" href="#__codelineno-25-27"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- ターン3：ロンドンの天気をリクエスト（許可されることを期待） ---&quot;</span><span class="p">)</span>
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28" href="#__codelineno-25-28"></a>        <span class="k">await</span> <span class="n">interaction_func</span><span class="p">(</span><span class="s2">&quot;ロンドンの天気を教えてください。&quot;</span><span class="p">)</span>
</span><span id="__span-25-29"><a id="__codelineno-25-29" name="__codelineno-25-29" href="#__codelineno-25-29"></a>
</span><span id="__span-25-30"><a id="__codelineno-25-30" name="__codelineno-25-30" href="#__codelineno-25-30"></a>    <span class="c1"># --- `run_tool_guardrail_test` async関数を実行 ---</span>
</span><span id="__span-25-31"><a id="__codelineno-25-31" name="__codelineno-25-31" href="#__codelineno-25-31"></a>    <span class="c1"># （...省略...）</span>
</span><span id="__span-25-32"><a id="__codelineno-25-32" name="__codelineno-25-32" href="#__codelineno-25-32"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&#39;await&#39;を使用した実行を試みています（ノートブックのデフォルト）...&quot;</span><span class="p">)</span>
</span><span id="__span-25-33"><a id="__codelineno-25-33" name="__codelineno-25-33" href="#__codelineno-25-33"></a>    <span class="k">await</span> <span class="n">run_tool_guardrail_test</span><span class="p">()</span>
</span><span id="__span-25-34"><a id="__codelineno-25-34" name="__codelineno-25-34" href="#__codelineno-25-34"></a>
</span><span id="__span-25-35"><a id="__codelineno-25-35" name="__codelineno-25-35" href="#__codelineno-25-35"></a>    <span class="c1"># --- 会話後の最終セッション状態を検査 ---</span>
</span><span id="__span-25-36"><a id="__codelineno-25-36" name="__codelineno-25-36" href="#__codelineno-25-36"></a>    <span class="c1"># オプション：ツールブロックトリガーフラグの状態を確認</span>
</span><span id="__span-25-37"><a id="__codelineno-25-37" name="__codelineno-25-37" href="#__codelineno-25-37"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- 最終セッション状態の検査（ツールガードレールテスト後） ---&quot;</span><span class="p">)</span>
</span><span id="__span-25-38"><a id="__codelineno-25-38" name="__codelineno-25-38" href="#__codelineno-25-38"></a>    <span class="c1"># この状態対応セッションに関連付けられたセッションサービスインスタンスを使用</span>
</span><span id="__span-25-39"><a id="__codelineno-25-39" name="__codelineno-25-39" href="#__codelineno-25-39"></a>    <span class="n">final_session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_service_stateful</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="n">APP_NAME</span><span class="p">,</span>
</span><span id="__span-25-40"><a id="__codelineno-25-40" name="__codelineno-25-40" href="#__codelineno-25-40"></a>                                                         <span class="n">user_id</span><span class="o">=</span><span class="n">USER_ID_STATEFUL</span><span class="p">,</span>
</span><span id="__span-25-41"><a id="__codelineno-25-41" name="__codelineno-25-41" href="#__codelineno-25-41"></a>                                                         <span class="n">session_id</span><span class="o">=</span> <span class="n">SESSION_ID_STATEFUL</span><span class="p">)</span>
</span><span id="__span-25-42"><a id="__codelineno-25-42" name="__codelineno-25-42" href="#__codelineno-25-42"></a>    <span class="k">if</span> <span class="n">final_session</span><span class="p">:</span>
</span><span id="__span-25-43"><a id="__codelineno-25-43" name="__codelineno-25-43" href="#__codelineno-25-43"></a>        <span class="c1"># 安全なアクセスのために.get()を使用</span>
</span><span id="__span-25-44"><a id="__codelineno-25-44" name="__codelineno-25-44" href="#__codelineno-25-44"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ツールガードレールトリガーフラグ：</span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;guardrail_tool_block_triggered&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;設定されていない（またはFalse）&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="__span-25-45"><a id="__codelineno-25-45" name="__codelineno-25-45" href="#__codelineno-25-45"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;最後の天気予報：</span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;last_weather_report&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;設定されていない&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># 成功すればロンドンの天気のはず</span>
</span><span id="__span-25-46"><a id="__codelineno-25-46" name="__codelineno-25-46" href="#__codelineno-25-46"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;温度単位：</span><span class="si">{</span><span class="n">final_session</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user_preference_temperature_unit&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;設定されていない&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># 華氏のはず</span>
</span><span id="__span-25-47"><a id="__codelineno-25-47" name="__codelineno-25-47" href="#__codelineno-25-47"></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="__span-25-48"><a id="__codelineno-25-48" name="__codelineno-25-48" href="#__codelineno-25-48"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">❌ エラー：最終セッション状態を取得できませんでした。&quot;</span><span class="p">)</span>
</span><span id="__span-25-49"><a id="__codelineno-25-49" name="__codelineno-25-49" href="#__codelineno-25-49"></a>
</span><span id="__span-25-50"><a id="__codelineno-25-50" name="__codelineno-25-50" href="#__codelineno-25-50"></a><span class="k">else</span><span class="p">:</span>
</span><span id="__span-25-51"><a id="__codelineno-25-51" name="__codelineno-25-51" href="#__codelineno-25-51"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">⚠️ ツールガードレールのテストをスキップします。ランナー（&#39;runner_root_tool_guardrail&#39;）が利用できません。&quot;</span><span class="p">)</span>
</span></code></pre></div>
<hr />
<p>出力を分析してください：</p>
<ol>
<li><strong>New York：</strong> <code>before_model_callback</code>がリクエストを許可します。LLMは<code>get_weather_stateful</code>を要求します。<code>before_tool_callback</code>が実行され、引数（<code>{'city': 'New York'}</code>）を検査し、「Paris」ではないことを見て、「ツール実行を許可...」と出力して<code>None</code>を返します。実際の<code>get_weather_stateful</code>関数が実行され、状態から「華氏」を読み取り、天気予報を返します。エージェントはこれを中継し、<code>output_key</code>を介して保存されます。</li>
<li><strong>Paris：</strong> <code>before_model_callback</code>がリクエストを許可します。LLMは<code>get_weather_stateful(city='Paris')</code>を要求します。<code>before_tool_callback</code>が実行され、引数を検査し、「Paris」を検出し、「ツール実行をブロックします！」と出力し、状態フラグを設定し、エラー辞書<code>{'status': 'error', 'error_message': 'ポリシー制限...'}</code>を返します。実際の<code>get_weather_stateful</code>関数は<strong>決して実行されません</strong>。エージェントは、まるでそれがツールの出力であるかのようにエラー辞書を受け取り、そのエラーメッセージに基づいて応答を形成します。</li>
<li><strong>London：</strong> New Yorkのように振る舞い、両方のコールバックを通過してツールを正常に実行します。新しいロンドンの天気予報が状態の<code>last_weather_report</code>を上書きします。</li>
</ol>
<p>これで、LLMに<em>何が</em>届くかだけでなく、LLMによって生成された特定の引数に基づいてエージェントのツールが<em>どのように</em>使用できるかを制御する、重要な安全層を追加しました。<code>before_model_callback</code>や<code>before_tool_callback</code>のようなコールバックは、堅牢で安全、かつポリシーに準拠したエージェントアプリケーションを構築するために不可欠です。</p>
<hr />
<h2 id="_1">結論：あなたのエージェントチームは準備完了です！<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>おめでとうございます！あなたは、Agent Development Kit (ADK) を使用して、基本的な単一の天気エージェントの構築から、洗練されたマルチエージェントチームの構築まで、見事にやり遂げました。</p>
<p><strong>達成したことのまとめ：</strong></p>
<ul>
<li>単一のツール（<code>get_weather</code>）を備えた<strong>基本的なエージェント</strong>から始めました。</li>
<li>LiteLLMを使用してADKの<strong>マルチモデルの柔軟性</strong>を探求し、Gemini、GPT-4o、Claudeなどの異なるLLMで同じコアロジックを実行しました。</li>
<li>専門のサブエージェント（<code>greeting_agent</code>、<code>farewell_agent</code>）を作成し、ルートエージェントからの<strong>自動委任</strong>を有効にすることで、<strong>モジュール性</strong>を取り入れました。</li>
<li><strong>セッション状態</strong>を使用してエージェントに<strong>メモリ</strong>を与え、ユーザーの好み（<code>temperature_unit</code>）や過去の対話（<code>output_key</code>）を記憶できるようにしました。</li>
<li><code>before_model_callback</code>（特定の入力キーワードのブロック）と<code>before_tool_callback</code>（「Paris」という都市のような引数に基づくツール実行のブロック）の両方を使用して、重要な<strong>安全ガードレール</strong>を実装しました。</li>
</ul>
<p>この先進的な天気ボットチームの構築を通じて、複雑でインテリジェントなアプリケーションを開発するために不可欠なADKのコアコンセプトについて、実践的な経験を積みました。</p>
<p><strong>主要なポイント：</strong></p>
<ul>
<li><strong>エージェントとツール：</strong> 能力と推論を定義するための基本的な構成要素。明確な指示とdocstringが最も重要です。</li>
<li><strong>ランナーとセッションサービス：</strong> エージェントの実行を調整し、会話のコンテキストを維持するエンジンとメモリ管理システム。</li>
<li><strong>委任：</strong> マルチエージェントチームを設計することで、専門化、モジュール性、および複雑なタスクのより良い管理が可能になります。エージェントの<code>description</code>は自動フローの鍵です。</li>
<li><strong>セッション状態（<code>ToolContext</code>, <code>output_key</code>）：</strong> 文脈を意識した、パーソナライズされた、複数ターンの会話型エージェントを作成するために不可欠です。</li>
<li><strong>コールバック（<code>before_model</code>, <code>before_tool</code>）：</strong> 重要な操作（LLM呼び出しまたはツール実行）の<em>前</em>に、安全性、検証、ポリシーの強制、および動的な変更を実装するための強力なフック。</li>
<li><strong>柔軟性（<code>LiteLlm</code>）：</strong> ADKは、パフォーマンス、コスト、機能を比較検討し、仕事に最適なLLMを選択する力を与えます。</li>
</ul>
<p><strong>次のステップは？</strong></p>
<p>あなたの天気ボットチームは素晴らしい出発点です。ADKをさらに探求し、アプリケーションを強化するためのアイデアをいくつか紹介します：</p>
<ol>
<li><strong>実際の天気API：</strong> <code>get_weather</code>ツールの<code>mock_weather_db</code>を、実際の天気API（OpenWeatherMap、WeatherAPIなど）への呼び出しに置き換えます。</li>
<li><strong>より複雑な状態：</strong> より多くのユーザー設定（例：好みの場所、通知設定）や会話の要約をセッション状態に保存します。</li>
<li><strong>委任の洗練：</strong> 委任ロジックを微調整するために、異なるルートエージェントの指示やサブエージェントの説明を試します。「予報」エージェントを追加できますか？</li>
<li><strong>高度なコールバック：</strong><ul>
<li><code>after_model_callback</code>を使用して、LLMの応答が生成された<em>後</em>に、それを再フォーマットまたはサニタイズする可能性があります。</li>
<li><code>after_tool_callback</code>を使用して、ツールから返された結果を処理またはログに記録します。</li>
<li>エージェントレベルのエントリ/エグジットロジックのために<code>before_agent_callback</code>または<code>after_agent_callback</code>を実装します。</li>
</ul>
</li>
<li><strong>エラーハンドリング：</strong> エージェントがツールのエラーや予期しないAPI応答を処理する方法を改善します。ツール内に再試行ロジックを追加するかもしれません。</li>
<li><strong>永続的なセッションストレージ：</strong> <code>InMemorySessionService</code>の代替として、セッション状態を永続的に保存する方法を探ります（例：FirestoreやCloud SQLのようなデータベースを使用 - カスタム実装または将来のADK統合が必要）。</li>
<li><strong>ストリーミングUI：</strong> エージェントチームをWebフレームワーク（FastAPIなど、ADKストリーミングクイックスタートで示されているように）と統合して、リアルタイムのチャットインターフェースを作成します。</li>
</ol>
<p>Agent Development Kitは、洗練されたLLM搭載アプリケーションを構築するための堅牢な基盤を提供します。このチュートリアルでカバーされた概念（ツール、状態、委任、コールバック）を習得することで、ますます複雑なエージェントシステムに取り組む準備が整いました。</p>
<p>開発を楽しんでください！</p>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  ページトップへ戻る
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="フッター" >
        
          
          <a href="../" class="md-footer__link md-footer__link--prev" aria-label="前: チュートリアル">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                前
              </span>
              <div class="md-ellipsis">
                チュートリアル
              </div>
            </div>
          </a>
        
        
          
          <a href="../../agents/" class="md-footer__link md-footer__link--next" aria-label="次: エージェント">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                次
              </span>
              <div class="md-ellipsis">
                エージェント
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright Google 2025
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.progress", "navigation.path", "navigation.top", "navigation.tracking", "toc.follow"], "search": "../../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f", "clipboard.copy": "\u30af\u30ea\u30c3\u30d7\u30dc\u30fc\u30c9\u3078\u30b3\u30d4\u30fc", "search.result.more.one": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3082\u30461\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.more.other": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3042\u3068#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.none": "\u4f55\u3082\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f", "search.result.one": "1\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.other": "#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.placeholder": "\u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044", "search.result.term.missing": "\u691c\u7d22\u306b\u542b\u307e\u308c\u306a\u3044", "select.version": "\u30d0\u30fc\u30b8\u30e7\u30f3\u5207\u308a\u66ff\u3048"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>